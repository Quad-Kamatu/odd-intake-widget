<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- ODD WIDGET v7 (height+cms) -->
  <title>ODD Intake Widget</title>
  <style>
    :root{ --pad:24px; }
    html, body { margin:0; padding:0; }
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Noto Sans', Helvetica, Arial; color:#0f172a; }
    .page { max-width: 900px; margin: 0 auto; padding: 16px; }
    .card { background:#fff; border:1px solid #e2e8f0; border-radius: 12px; padding: 16px; box-shadow: 0 8px 24px rgba(2,6,23,.06); }
    .field { margin-bottom: 12px; }
    .field label{ display:block; font-weight:600; margin-bottom:6px; }
    .field input, .field select, .field textarea { width:100%; border:1px solid #cbd5e1; border-radius: 8px; padding: 10px 12px; }
    .btn { border:1px sol id transparent; border-radius:10px; padding:10px 14px; font-weight:700; background:#0f172a; color:#fff; cursor:pointer; }
    .btn[disabled] { background:#e2e8f0; color:#64748b; cursor:not-allowed; }
  </style>
</head>
<body>
  <div id="widgetRoot" class="page">
    <div id="pageHeader" class="mb-2">
      <div style="font-size:.9rem; letter-spacing:.06em; text-transform:uppercase; color:#475569; font-weight:600;">One Day Dance</div>
      <h1 style="font-size:1.6rem; font-weight:800; margin:.2rem 0;">Service Request</h1>
    </div>

    <!-- Identity -->
    <div id="identityCard" class="card">
      <div class="field"><label>First name</label><input id="firstNameInput" type="text" required /></div>
      <div class="field"><label>Last name</label><input id="lastNameInput" type="text" required /></div>
      <div class="field"><label>Email</label><input id="emailInput" type="email" required /></div>
    </div>

    <!-- Success -->
    <div id="successScreen" class="card" style="display:none; margin-top:12px;">
      <div style="font-size:.9rem; letter-spacing:.06em; text-transform:uppercase; color:#475569; font-weight:600;">All set</div>
      <h2 style="font-size:1.2rem; font-weight:800; margin:.2rem 0;">Thanks — your request was sent!</h2>
      <p style="color:#475569;">We’ll follow up by email shortly.</p>
      <div style="font-size:.9rem; color:#475569;">Submitted: <span id="successRef"></span></div>
    </div>

    <!-- Form -->
    <div id="formCard" class="card" style="margin-top:12px;">
      <form id="intakeForm" novalidate>
        <div id="serviceCardWrap" class="field"></div>

        <!-- Mailing list (default yes) -->
        <div class="field">
          <label>Join our mailing list?</label>
          <label style="margin-right:18px;"><input type="radio" name="mailing" value="yes" checked /> Yes</label>
          <label><input type="radio" name="mailing" value="no" /> No</label>
        </div>

        <div class="field"><label><input id="tosCheck" type="checkbox" required /> I agree to the Terms</label></div>
        <div class="field"><label><input id="understandCheck" type="checkbox" required /> I understand this is a request, not a final booking</label></div>

        <button id="submitBtn" class="btn" type="submit" disabled>Submit Request</button>
      </form>
    </div>
  </div>

<script>
// ---------------- CONFIG ----------------
const CONFIG = {
  api: { baseUrl: 'https://www.onedaydance.com/_functions', catalogPath: '/catalog', submitPath: '/submit' },
  catalog: null
};

// v7: Dynamically align API base URL to parent origin (Wix) to avoid CORS
(function(){
  try{
    const parentOrigin = document.referrer ? new URL(document.referrer).origin : '';
    const urlParent = new URLSearchParams(location.search).get('parentOrigin');
    const chosen = urlParent || parentOrigin;
    if (chosen) {
      CONFIG.api.baseUrl = chosen + '/_functions';
    }
  }catch(_){}
})();

const ALLOWED_PARENTS = ['https://www.onedaydance.com','https://onedaydance.com'];

// ---------------- HEIGHT PROTOCOL (inspired by iframe-resizer) ----------------
(function(){
  const st = { id: String(Math.random()).slice(2), success:false, last:0, gotParent:false };

  function measure(){
    const html = document.documentElement;
    const body = document.body;
    const root = document.getElementById('widgetRoot') || document.querySelector('.page') || body;
    const succ = document.getElementById('successScreen');
    if (st.success && succ && succ.offsetParent !== null) {
      const pad = 24; return Math.max(200, Math.ceil(succ.getBoundingClientRect().height + pad));
    }
    let h=0;
    try { h = Math.max(h, Math.ceil(root.getBoundingClientRect().height)); } catch(_){}
    try { h = Math.max(h, root.scrollHeight||0, root.offsetHeight||0); } catch(_){}
    try { h = Math.max(h, body.scrollHeight||0, body.offsetHeight||0); } catch(_){}
    try { h = Math.max(h, html.clientHeight||0, html.scrollHeight||0, html.offsetHeight||0); } catch(_){}
    return Math.max(200, h);
  }

  function send(reason){
    const h = measure();
    st.last = h;
    const std = { type:'ODD_FORM_HEIGHT', height:h, ts:Date.now(), childId: st.id, reason };
    const v3  = { type:'ODD_HEIGHT_V3', height:h, ts:Date.now(), childId: st.id, reason };
    const leg = { oddIntakeHeight:h, ts:Date.now(), childId: st.id, reason };
    (ALLOWED_PARENTS||[]).forEach(o=>{ try{ parent.postMessage(std,o); parent.postMessage(leg,o); parent.postMessage(v3,o);}catch(_){}});
    try{ parent.postMessage(std,'*'); parent.postMessage(leg,'*'); parent.postMessage(v3,'*'); }catch(_){}
    try{ if (window.frameElement && window.frameElement.style){ window.frameElement.style.height = h+'px'; } }catch(_){}
  }

  // handshake + polling
  function ready(){ const m={ type:'ODD_CHILD_READY', ts:Date.now(), childId:st.id }; (ALLOWED_PARENTS||[]).forEach(o=>{ try{ parent.postMessage(m,o);}catch(_){}}); try{ parent.postMessage(m,'*'); }catch(_){}};
  window.addEventListener('message', (e)=>{
    const d = e && e.data || {};
    if (d.type === 'ODD_HOST_READY') { st.gotParent = true; send('host_ready'); }
    if (d.type === 'ODD_REQUEST_HEIGHT') send('request');
    if (d.type === 'ODD_HOST_SUCCESS_MODE') { st.success = true; send('force_success'); }
  });

  // observers
  try{ new ResizeObserver(()=>send('resize')).observe(document.body); }catch(_){}
  try{ new MutationObserver(()=>send('mutate')).observe(document.body, { childList:true, subtree:true, attributes:true }); }catch(_){}
  try{ Array.from(document.images||[]).forEach(img=>{ if(!img.complete) img.addEventListener('load', ()=>send('img'), {once:true}); }); }catch(_){}
  if (document.fonts && document.fonts.ready) document.fonts.ready.then(()=>send('fonts')).catch(()=>{});
  window.addEventListener('load', ()=>send('load'));
  window.addEventListener('resize', ()=>send('window_resize'));

  // raf storm (first 4s) + keepalive for 6s
  (function rafLoop(){ let f=0, max=240, last=0; function step(){ f++; const h=measure(); if (Math.abs(h-last)>1){ last=h; send('raf'); } if (f<max) requestAnimationFrame(step);} requestAnimationFrame(step);} )();
  const keep = setInterval(()=>send('keep'), 500); setTimeout(()=>clearInterval(keep), 6000);

  // expose success switch
  window.__oddEnterSuccessMode = function(){ st.success = true; send('enter_success'); };

  ready();
})();

// ---------------- RPC: parent fetch for same-origin URLs ----------------
(function(){
  const pending = new Map(); let seq=1;
  window.__oddParentFetch = function(input, init){
    return new Promise((resolve,reject)=>{
      const id='f'+(seq++); const to=setTimeout(()=>{ pending.delete(id); reject(new Error('Parent fetch timeout')); }, 10000);
      pending.set(id,{resolve,reject,to});
      try{ parent.postMessage({ type:'ODD_FETCH', id, input, init }, '*'); }catch(e){ clearTimeout(to); pending.delete(id); reject(e); }
    });
  };
  window.addEventListener('message',(e)=>{
    const d = e && e.data || {};
    if (d.type!=='ODD_FETCH_RESULT' || !d.id) return;
    const p = pending.get(d.id); if (!p) return;
    clearTimeout(p.to); pending.delete(d.id);
    if (d.error) return p.reject(new Error(d.error));
    return p.resolve(d.kind==='json' ? d.body : d.body);
  });
})();

// ---------------- Catalog + Form ----------------
const esc = s=>String(s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m]));

async function loadCatalog(){
  const url = `${CONFIG.api.baseUrl}${CONFIG.api.catalogPath}`;
  // try direct
  try{
    const r = await fetch(url, { headers:{ 'Content-Type':'application/json' } });
    if (!r.ok) throw new Error('HTTP '+r.status);
    const data = await r.json();
    if (!data || !Array.isArray(data.services)) throw new Error('Bad catalog');
    CONFIG.catalog = { services:data.services, pricing:data.pricing||[], addons:data.addons||[] };
    return true;
  }catch(_){
    // fallback via parent
    try{
      const data = await (window.__oddParentFetch?window.__oddParentFetch(url, { method:'GET' }):Promise.reject(new Error('No parent fetch')));
      if (!data || !Array.isArray(data.services)) throw new Error('Bad catalog');
      CONFIG.catalog = { services:data.services, pricing:data.pricing||[], addons:data.addons||[] };
      return true;
    }catch(err){
      console.error('catalog error', err);
      document.getElementById('serviceCardWrap').innerHTML = '<div style="padding:8px; background:#fff7ed; border:1px solid #fed7aa; border-radius:8px;">Catalog temporarily unavailable.</div>';
      return false;
    }
  }
}

function buildServiceUI(){
  const host = document.getElementById('serviceCardWrap'); host.innerHTML='';
  const services = CONFIG.catalog?.services || [];
  if (!services.length){ host.textContent='No services available right now.'; return; }
  const sel = document.createElement('select'); sel.id='serviceType';
  sel.innerHTML = services.map(s=>`<option value="${esc(s.serviceKey||s.key||s.id||'')}">${esc(s.serviceName||s.name||'Service')}</option>`).join('');
  host.appendChild(sel);

  const sub = document.createElement('select'); sub.id='serviceSub'; sub.style.marginTop='8px';
  host.appendChild(sub);

  function updateSubs(){
    const key = sel.value;
    const pricing = CONFIG.catalog?.pricing || [];
    const subs = pricing.filter(p=>String(p.serviceKey||p.key)===String(key));
    const names = Array.from(new Set(subs.map(p=>p.subType||p.variant||'Default')));
    sub.innerHTML = names.map(n=>`<option value="${esc(n)}">${esc(n)}</option>`).join('');
  }
  sel.addEventListener('change', ()=>{ updateSubs(); });
  updateSubs();
}

function updateSubmitState(){
  const form = document.getElementById('intakeForm');
  const btn = document.getElementById('submitBtn');
  if (!btn || !form) return;
  const first = document.getElementById('firstNameInput');
  const last  = document.getElementById('lastNameInput');
  const email = document.getElementById('emailInput');
  const identityOk =
    (!!first && !!first.value.trim()) &&
    (!!last  && !!last.value.trim())  &&
    (!!email && !!email.value.trim() && email.checkValidity && email.checkValidity());
  const ok = form.checkValidity && form.checkValidity() && identityOk;
  btn.disabled = !ok;
}

document.addEventListener('DOMContentLoaded', async ()=>{
  const ok = await loadCatalog();
  if (ok) buildServiceUI();
  updateSubmitState();
  document.getElementById('intakeForm').addEventListener('input', updateSubmitState);
  document.getElementById('intakeForm').addEventListener('change', updateSubmitState);

  document.getElementById('intakeForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const first = document.getElementById('firstNameInput');
    const last  = document.getElementById('lastNameInput');
    const email = document.getElementById('emailInput');
    if (!first.value.trim() || !last.value.trim() || !email.value.trim() || !email.checkValidity()) { updateSubmitState(); (first.reportValidity||(()=>{}))(); return; }

    const payload = {
      firstName: first.value.trim(),
      lastName: last.value.trim(),
      email: email.value.trim().toLowerCase(),
      mailingOptIn: (document.querySelector('input[name="mailing"]:checked')?.value === 'yes'),
      service: {
        serviceKey: document.getElementById('serviceType')?.value || '',
        subType: document.getElementById('serviceSub')?.value || '',
      },
      tosAccepted: !!document.getElementById('tosCheck')?.checked,
      bookingAcknowledge: !!document.getElementById('understandCheck')?.checked
    };

    const url = `${CONFIG.api.baseUrl}${CONFIG.api.submitPath}`;
    let ok = false, err = null;
    try{
      const r = await fetch(url, { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payload) });
      ok = !!(r && r.ok);
    }catch(e){ err=e; }
    if (!ok){
      try{
        await (window.__oddParentFetch ? window.__oddParentFetch(url, { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payload) }) : Promise.reject(new Error('No parent fetch')));
        ok = true;
      }catch(e){ err = err || e; }
    }
    if (!ok){ alert('Sorry, something went wrong sending your request.'); return; }

    // success
    document.getElementById('intakeForm').remove();
    document.getElementById('identityCard')?.remove();
    document.getElementById('pageHeader')?.remove();
    const succ = document.getElementById('successScreen');
    succ.style.display='';
    document.getElementById('successRef').textContent = new Date().toLocaleString();
    try{ window.__oddEnterSuccessMode && window.__oddEnterSuccessMode(); }catch(_){}
    // notify success with tight height as well
    const sh = Math.ceil(succ.getBoundingClientRect().height + 24);
    (ALLOWED_PARENTS||[]).forEach(o=>{ try{ parent.postMessage({type:'ODD_FORM_SUCCESS', height:sh, ts:Date.now()}, o);}catch(_){}});
    try{ parent.postMessage({type:'ODD_FORM_SUCCESS', height:sh, ts:Date.now()}, '*'); }catch(_){}
    try{ if (window.frameElement && window.frameElement.style){ window.frameElement.style.height = sh+'px'; } }catch(_){}
  });
});
</script>
</body>
</html>
