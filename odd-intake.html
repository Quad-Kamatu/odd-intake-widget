<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Odd Embeddable Intake Widget</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --c1:#FF9D76; /* coral */
      --c2:#76F1FF; /* cyan */
      --c3:#C176FF; /* violet */
      --c4:#FFE176; /* saffron */
    }

    @property --ang { syntax: '<angle>'; inherits: false; initial-value: 0deg; }

    html, body { height: 100%; margin:0; padding:0; background:transparent; }
    body{ color:#111; position:relative; }

    /* Fluid, shifting gradient background */
    html::before{
      content:"";
      position:fixed; left:0; top:0; right:0; bottom:0; width:100vw; height:100vh; z-index:-1;
      background: linear-gradient(var(--ang), var(--c1), var(--c2), var(--c3), var(--c4));
      background-size: 200% 200%;
      animation: bg-pan 18s ease-in-out infinite alternate, bg-rotate 36s linear infinite;
      filter: saturate(1.03);
      pointer-events:none;
    }

    @keyframes bg-pan { 0%{background-position:0% 0%} 50%{background-position:100% 0%} 100%{background-position:0% 100%} }
    @keyframes bg-rotate { to { --ang: 360deg; } }
    @media (prefers-reduced-motion: reduce){ body::before{ animation:none; } }

    .card{ box-shadow:0 8px 20px rgba(0,0,0,.06); border-radius:16px; background:#fff; padding:24px; border:1px solid #eaeaea; }
    .lbl{ font-size:0.9rem; font-weight:600; color:#222; }
    .inp{ width:100%; margin-top:4px; border:1px solid #ddd; border-radius:12px; padding:10px 12px; outline:none; }
    .inp:focus{ border-color:#111; box-shadow:0 0 0 2px rgba(0,0,0,.08); }
    .row{ display:grid; grid-template-columns:1fr; gap:16px; }
    @media(min-width:768px){ .row{ grid-template-columns:1fr 1fr; } }
    .btn{ display:inline-flex; align-items:center; justify-content:center; border-radius:12px; padding:10px 14px; font-weight:700; border:1px solid #222; transition: background-color .18s ease, color .18s ease, border-color .18s ease; }
    .btn-primary, .btn-primary:link, .btn-primary:visited{ background:#FF9D76 !important; border-color:#FF9D76 !important; color:#fff !important; }
    .btn-primary:hover, .btn-primary:focus, .btn-primary:focus-visible, .btn-primary:active{ background:#76F1FF !important; border-color:#76F1FF !important; color:#111 !important; }
    .btn-disabled{ background:#e5e7eb; border-color:#d1d5db; color:#9ca3af; cursor:not-allowed; }
    .badge{ display:inline-block; border-radius:9999px; font-size:.85rem; padding:6px 10px; border:1px solid #ccc; background:#f3f3f3; color:#111; }
    .mono{ font-variant-numeric: tabular-nums; }
    .muted{ opacity:.6; }
    a.link{ color:#111; text-decoration:underline; }
    .service-card{ border:1px dashed #e5e7eb; border-radius:16px; padding:16px; }
    .page-title, .page-subtitle{ color:#fff; text-shadow:0 1px 2px rgba(0,0,0,.25); }

    /* Film length slider styles */
    .filmSlider{ --val:0%; accent-color:#76F1FF; height:2rem; width:100%; background:linear-gradient(to right, #76F1FF 0%, #76F1FF var(--val), #dbeafe var(--val), #dbeafe 100%); border-radius:9999px; }
    .filmSlider:focus{ outline:none; }
    .filmSlider::-webkit-slider-runnable-track{ height:6px; border-radius:9999px; background:linear-gradient(to right, #76F1FF 0%, #76F1FF var(--val), #dbeafe var(--val), #dbeafe 100%); }
    .filmSlider::-webkit-slider-thumb{ -webkit-appearance:none; appearance:none; width:18px; height:18px; border-radius:9999px; background:#76F1FF; border:2px solid #76F1FF; margin-top:-6px; box-shadow:0 1px 2px rgba(0,0,0,.15); }
    .filmSlider:focus::-webkit-slider-thumb{ box-shadow:0 0 0 4px rgba(118,241,255,.25); }
    .filmSlider::-moz-range-track{ height:6px; border-radius:9999px; background:#dbeafe; }
    .filmSlider::-moz-range-progress{ height:6px; border-radius:9999px; background:#76F1FF; }
    .filmSlider::-moz-range-thumb{ width:18px; height:18px; border-radius:9999px; background:#76F1FF; border:2px solid #76F1FF; box-shadow:0 1px 2px rgba(0,0,0,.15); }

    .service-card .row,
    .service-card .eventRow,
    .service-card .locationRow,
    .service-card .qtyRow,
    .service-card .headshotRow,
    .service-card .complexityWrap,
    .service-card .audioWrap,
    .service-card .addonsWrap{ margin-bottom:16px; }
    .service-card .filmLenWrap{ margin-bottom:12px; }
    .service-card .complexityWrap .help{ margin-top:8px; }
    .service-card > :last-child{ margin-bottom:0 !important; }

    @keyframes spin{ to{ transform: rotate(360deg); } }
    .spinner{ width:1rem; height:1rem; display:inline-block; animation: spin 1s linear infinite; margin-right:.5rem; vertical-align:middle; }
    .btn.btn-loading{ cursor:progress; }
  </style>
</head>
<body class="text-gray-900">
  <div class="max-w-4xl mx-auto p-6 space-y-6">
    <div id="pageHeader" class="mb-2">
      <h1 class="text-2xl font-semibold page-title">Service Request</h1>
    </div>

    <!-- Identity & Discounts -->
    <div id="identityCard" class="card">
      <div class="grid md:grid-cols-2 gap-4">
        <div class="space-y-4">
          <div class="lbl">Your Info</div>
          <div class="row">
            <label class="block">
              <span class="lbl">First Name *</span>
              <input id="firstNameInput" required type="text" class="inp" placeholder="Jane" />
            </label>
            <label class="block">
              <span class="lbl">Last Name *</span>
              <input id="lastNameInput" required type="text" class="inp" placeholder="Doe" />
            </label>
          </div>
          <label class="block">
            <span class="lbl">Email *</span>
            <input id="emailInput" required type="email" class="inp" placeholder="you@example.com" />
          </label>
          <label class="block">
            <span class="lbl">Organization Name (optional)</span>
            <input id="orgInput" type="text" class="inp" placeholder="Organization (if applicable)" />
          </label>
        </div>
        <div class="space-y-4">
          <div class="lbl">Discount Qualification</div>
          <div>
            <div class="text-sm text-gray-700 mb-2">Do you qualify for one of these discounts? (select one)</div>
            <div class="flex flex-col gap-2 text-sm">
              <label class="inline-flex items-center gap-2"><input type="radio" name="selfDiscount" value="none" checked /> None</label>
              <label class="inline-flex items-center gap-2"><input type="radio" name="selfDiscount" value="student" /> Student - 10% (show student ID)</label>
              <label class="inline-flex items-center gap-2"><input type="radio" name="selfDiscount" value="nonprofit" /> 501(c)(3) or fiscally sponsored - 10%</label>
              <label class="inline-flex items-center gap-2"><input type="radio" name="selfDiscount" value="odd_artist" /> ODD Artist - 20%</label>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Services Form -->
    <form id="intakeForm" class="space-y-6" novalidate>
      <div id="servicesContainer" class="space-y-6"></div>

      <div class="card bg-white border border-gray-200">
        <div class="flex items-center justify-between">
          <div class="lbl">Additional Services</div>
          <button id="addServiceBtn" type="button" class="btn">+ Add another service</button>
        </div>
      </div>

      <div class="card">
        <h3 class="font-semibold mb-2">Estimate</h3>
        <div class="grid lg:grid-cols-3 gap-4">
          <div class="lg:col-span-2 card bg-gray-50 border border-gray-200">
            <h4 class="font-semibold mb-2">Quote Breakdown</h4>
            <div id="quoteBreakdown" class="text-sm space-y-1"><div class="text-gray-500">-</div></div>
          </div>
          <div class="flex items-start justify-center pt-2">
            <div class="relative w-56 h-56">
              <canvas id="donutChart" width="224" height="224" class="w-56 h-56"></canvas>
              <div class="absolute inset-0 flex items-center justify-center">
                <div class="text-center">
                  <div class="text-xs text-gray-500">Total</div>
                  <div id="quoteTotal" class="text-sm font-bold mono">$0</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="card bg-gray-50 border border-gray-200">
        <div class="space-y-4">
          <label class="block">
            <span class="lbl">Additional relevant information</span>
            <textarea id="additionalInfo" rows="3" class="inp" placeholder="Anything else we should know?"></textarea>
          </label>

          <label class="block">
            <span class="lbl">Requested providers (optional)</span>
            <input id="requestedProviders" type="text" class="inp" placeholder="e.g., preferred videographer/photographer names" />
          </label>

          <label class="flex items-start gap-3">
            <input id="tosCheck" type="checkbox" required class="mt-1" />
            <span class="text-sm">I have read and agree to the <a class="link" href="https://www.onedaydance.com/terms" target="_blank" rel="noopener noreferrer">Terms of Service</a> *</span>
          </label>
          <label class="flex items-start gap-3">
            <input id="understandCheck" type="checkbox" required class="mt-1" />
            <span class="text-sm">I understand that submitting this form does not constitute confirmation of booking *</span>
          </label>
          <div>
            <div class="lbl mb-2">Would you like to join our mailing list to receive offers and promotions?</div>
            <div class="flex items-center gap-6 text-sm">
              <label class="inline-flex items-center gap-2"><input type="radio" name="mailing" value="yes" checked /> Yes</label>
              <label class="inline-flex items-center gap-2"><input type="radio" name="mailing" value="no" /> No</label>
            </div>
          </div>
          <button id="submitBtn" type="submit" class="btn btn-disabled w-full" disabled>Submit Request</button>
        </div>
      </div>
    </form>

    <div id="successScreen" class="card" style="display:none;">
      <h2 class="text-xl font-semibold mb-2">Thanks â€" your request was sent!</h2>
      <p class="text-sm text-gray-700 mb-4">We'll follow up by email shortly.</p>
      <div class="text-sm text-gray-600">Submitted: <span id="successRef" class="mono"></span></div>
      <div class="mt-4">
        <a href="https://www.onedaydance.com/services" target="_top" rel="noopener" class="btn btn-primary">Return to Services</a>
      </div>
    </div>
  </div>

  <script>
  // -------- CONFIG / CATALOG --------
  const CONFIG = {
    mode: 'api',
    api: { baseUrl: 'https://www.onedaydance.com/_functions', webhookPath: '/submit', catalogPath: '/catalog' },
    catalog: null
  };
  const ALLOWED_PARENTS = ['https://www.onedaydance.com', 'https://onedaydance.com'];

  // -------- HEIGHT MESSAGING (COMPLETELY FIXED) --------
  let currentHeight = 0;
  let heightRequestId = null;

  function postHeights(px) {
    try {
      const ts = Date.now();
      const msgStd = { type:'ODD_FORM_HEIGHT', height:px, ts };
      const msgLegacy = { oddIntakeHeight: px, ts };
      if (window.parent && window.parent !== window) {
        (ALLOWED_PARENTS||[]).forEach(origin=>{
          try { window.parent.postMessage(msgStd, origin); } catch(_) {/*noop*/}
          try { window.parent.postMessage(msgLegacy, origin); } catch(_) {/*noop*/}
        });
      }
    } catch(_) {/*noop*/}
  }

  function measureHeight() {
    // Force layout recalculation
    document.body.offsetHeight;
    
    // Special handling for success screen
    const successScreen = document.getElementById('successScreen');
    if (successScreen && successScreen.style.display !== 'none') {
      // Measure success screen plus padding
      const containerPadding = 48; // Account for body padding
      const successHeight = successScreen.getBoundingClientRect().height;
      const headerHeight = document.getElementById('pageHeader')?.getBoundingClientRect().height || 0;
      return Math.ceil(successHeight + headerHeight + containerPadding);
    }
    
    // Measure the actual content height using multiple methods for accuracy
    const container = document.querySelector('.max-w-4xl');
    if (container) {
      // Get the actual content bounds
      const containerRect = container.getBoundingClientRect();
      const containerScrollHeight = container.scrollHeight;
      
      // Use the larger of the two measurements
      let contentHeight = Math.max(containerRect.height, containerScrollHeight);
      
      // Add body padding
      const bodyPadding = 24; // Based on p-6 class (1.5rem = 24px)
      contentHeight += bodyPadding;
      
      return Math.ceil(contentHeight);
    }
    
    // Fallback measurements
    const docHeight = document.documentElement.scrollHeight;
    const bodyHeight = document.body.scrollHeight;
    return Math.ceil(Math.max(docHeight, bodyHeight, 200));
  }

  function sendHeight() {
    // Cancel any pending updates
    if (heightRequestId) {
      cancelAnimationFrame(heightRequestId);
      heightRequestId = null;
    }
    
    heightRequestId = requestAnimationFrame(() => {
      try {
        const newHeight = measureHeight();
        
        // FIXED: Always send height updates, even when shrinking
        // The old code had logic that prevented shrinking - removed that
        if (Math.abs(newHeight - currentHeight) > 1) { // Only skip tiny changes
          currentHeight = newHeight;
          postHeights(newHeight);
        }
      } catch(e) {
        console.warn('Height measurement error:', e);
      }
      heightRequestId = null;
    });
  }

  // Immediate height sending for critical updates
  function sendHeightImmediate() {
    try {
      const newHeight = measureHeight();
      currentHeight = newHeight;
      postHeights(newHeight);
    } catch(e) {
      console.warn('Immediate height measurement error:', e);
    }
  }

  // Debounced version for frequent events
  let debounceTimer = null;
  function sendHeightDebounced() {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(sendHeight, 16); // ~60fps
  }

  // -------- UTILS --------
  const $ = (sel) => document.querySelector(sel);
  const money = (n) => (Number(n)||0).toFixed(2);
  const esc = (s) => String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  const uid = () => Math.random().toString(36).slice(2,9);
  function updateSliderFill(el){ if(!el) return; const min=parseFloat(el.min)||0, max=parseFloat(el.max)||100, val=parseFloat(el.value)||0; const pct=(max>min)?((val-min)/(max-min))*100:0; el.style.setProperty('--val', pct+'%'); }
  function to12h(h,m){ const ampm=h>=12?'PM':'AM'; let hh=h%12; if(hh===0) hh=12; return `${hh}:${String(m).padStart(2,'0')} ${ampm}`; }
  function addHoursToTime(timeStr, hours){ if(!timeStr) return ''; const [hStr,mStr='0']=String(timeStr).split(':'); const h=parseInt(hStr,10), m=parseInt(mStr,10); const total=h*60+m+Math.round((Number(hours)||0)*60); const nh=((Math.floor(total/60))%24+24)%24, nm=((total%60)+60)%60; return to12h(nh,nm); }
  function combineDateTime(dateStr, timeStr){ if(!dateStr||!timeStr) return ''; return `${dateStr} ${timeStr}:00`; }

  // -------- STATE --------
  const state = { services: [] };

  // -------- CHART COLORS --------
  const CHART_COLORS = [
    '#FF9D76', // coral
    '#76F1FF', // cyan  
    '#C176FF', // violet
    '#FFE176', // saffron
    '#FF7676', // red
    '#76FF9D', // green
    '#9D76FF', // purple
    '#76FFE1', // teal
    '#FFB376', // orange
    '#B376FF'  // indigo
  ];

  // -------- IMPROVED DONUT CHART --------
  function createDonutChart(canvas, data) {
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    if (!ctx) return;
    
    const centerX = canvas.width / 2;
    const centerY = canvas.height / 2;
    const outerRadius = 87;
    const innerRadius = 52;
    
    // Clear canvas
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // Always draw background ring
    ctx.beginPath();
    ctx.arc(centerX, centerY, outerRadius, 0, 2 * Math.PI);
    ctx.arc(centerX, centerY, innerRadius, 0, 2 * Math.PI, true);
    ctx.fillStyle = '#f3f4f6'; // Light grey background
    ctx.fill();
    
    // Add subtle border to background ring
    ctx.strokeStyle = '#e5e7eb';
    ctx.lineWidth = 1;
    ctx.stroke();
    
    if (!data.length) return;
    
    const total = data.reduce((sum, item) => sum + item.value, 0);
    if (total === 0) return;
    
    let currentAngle = -Math.PI / 2; // Start at top
    
    data.forEach((item, index) => {
      const sliceAngle = (item.value / total) * 2 * Math.PI;
      const color = CHART_COLORS[index % CHART_COLORS.length];
      
      if (sliceAngle > 0.01) {
        // Draw slice
        ctx.beginPath();
        ctx.arc(centerX, centerY, outerRadius, currentAngle, currentAngle + sliceAngle);
        ctx.arc(centerX, centerY, innerRadius, currentAngle + sliceAngle, currentAngle, true);
        ctx.closePath();
        ctx.fillStyle = color;
        ctx.fill();
        
        // Add subtle border
        ctx.strokeStyle = '#ffffff';
        ctx.lineWidth = 2;
        ctx.stroke();
      }
      
      currentAngle += sliceAngle;
    });
  }

  function bestDiscountPercent(){ const selfVal = document.querySelector('input[name="selfDiscount"]:checked')?.value || 'none'; return selfVal==='odd_artist'?20:((selfVal==='student'||selfVal==='nonprofit')?10:0); }

  function serviceEligibleForComplexity(meta){ return !!meta?.hasComplexity; }
  function isVideography(meta){ return (meta?.serviceKey||'').toLowerCase()==='videography'; }
  function isVideoEditing(meta){ return (meta?.subType||'')==='Video Editing'; }

  // -------- CATALOG LOADER --------
  async function loadCatalog(){
    const url = `${CONFIG.api.baseUrl}${CONFIG.api.catalogPath}`;
    const controller = new AbortController();
    const to = setTimeout(()=>controller.abort(), 8000);
    try{
      const res = await fetch(url, { headers:{ 'Content-Type':'application/json' }, signal: controller.signal });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      const normalizeKey = (s) => String(s||'').trim();
      const services = (data.services||[]).map(s=>({ serviceKey: normalizeKey(s.serviceKey), serviceName: s.name || s.serviceName || normalizeKey(s.serviceKey) }));
      const pricing  = (data.pricing || []).map(p=>({ ...p, serviceKey: normalizeKey(p.serviceKey) }));
      const addons   = (data.addons  || []).map(a=>({ ...a, appliesToCategories: (a.appliesToCategories||[]).map(normalizeKey) }));
      if (!services.length || !pricing.length) throw new Error('Empty catalog');
      CONFIG.catalog = { services, pricing, addons };
      return true;
    } finally { clearTimeout(to); }
  }

  function renderFatal(message){
    const root = document.querySelector('.max-w-4xl');
    if (!root) return;
    root.innerHTML = `
      <div class="card bg-white border border-red-200">
        <h2 class="text-xl font-semibold text-red-700 mb-2">Service Request temporarily unavailable</h2>
        <p class="text-sm text-gray-700 mb-3">${esc(message || 'Our services catalog is currently unavailable.')}</p>
        <p class="text-sm text-gray-700">Please email
          <a class="link" href="mailto:info@onedaydance.com">info@onedaydance.com</a>
          with your request while we resolve this.
        </p>
      </div>`;
    sendHeightImmediate();
  }

  // -------- SERVICE CARD --------
  function createServiceState(id){ return { id, offeringId:'', serviceKey:'', subType:'', date:'', time:'', location:'', hours:1, units:1, complexity:'simple', audio:null, addons: {}, addonHours: {} }; }

  function buildServiceCard(svc){
    const wrap = document.createElement('div');
    wrap.className = 'card service-card';
    wrap.dataset.id = svc.id;
    wrap.innerHTML = `
      <div class="flex items-center justify-between mb-3">
        <div class="font-semibold">Service ${svc.id==='primary'?'(Primary)':''}</div>
        ${svc.id!=='primary'?'<button type="button" class="btn remove">Remove</button>':''}
      </div>
      <div class="row">
        <label class="block">
          <span class="lbl">Service Type *</span>
          <select class="inp serviceType" required></select>
        </label>
        <label class="block">
          <span class="lbl">Service *</span>
          <select class="inp subType" required disabled></select>
        </label>
      </div>
      <div class="row eventRow" style="display:none;">
        <label class="block">
          <span class="lbl">Date *</span>
          <input type="date" class="inp date" />
        </label>
        <label class="block">
          <span class="lbl">Time *</span>
          <input type="time" class="inp time" />
        </label>
      </div>
      <label class="block locationRow" style="display:none;">
        <span class="lbl">Location *</span>
        <input type="text" class="inp location" placeholder="Venue / Address" />
      </label>

      <div class="row qtyRow" style="display:none;">
        <label class="block hoursWrap">
          <span class="lbl">Hours *</span>
          <input type="number" min="1" value="1" class="inp hours" />
        </label>
        <div class="filmLenWrap" style="display:none;">
          <label class="block">
            <span class="lbl">Expected Film Length (minutes) *</span>
            <input type="range" min="0.5" max="20" step="0.5" value="1" class="w-full filmSlider" />
          </label>
          <div class="flex items-center gap-2 mt-2">
            <input type="number" min="0.5" step="0.5" value="1" class="inp units" />
            <span class="text-sm text-gray-600">min</span>
          </div>
        </div>
      </div>

      <div class="row headshotRow" style="display:none;">
        <label class="block">
          <span class="lbl">Number of Headshots *</span>
          <input type="number" min="1" value="1" class="inp headshots" />
        </label>
      </div>

      <div class="row complexityWrap" style="display:none;">
        <label class="block">
          <span class="lbl">Editing Complexity *</span>
          <select class="inp complexity"></select>
        </label>
        <div class="card bg-gray-50 border border-gray-200 text-sm text-gray-700 help"></div>
      </div>

      <div class="row audioWrap" style="display:none;">
        <div>
          <div class="lbl mb-2">Is audio recording necessary? *</div>
          <div class="flex items-center gap-6 text-sm">
            <label class="inline-flex items-center gap-2"><input type="radio" name="audio-${svc.id}" value="yes" /> Yes</label>
            <label class="inline-flex items-center gap-2"><input type="radio" name="audio-${svc.id}" value="no" /> No</label>
          </div>
        </div>
      </div>

      <div class="card bg-gray-50 border border-gray-200 addonsWrap" style="display:none;">
        <div class="lbl mb-3">Add-ons</div>
        <div class="addonsList grid gap-3"></div>
      </div>
    `;

    const typeSel = wrap.querySelector('.serviceType');
    typeSel.innerHTML = (CONFIG.catalog.services||[]).map(s=>`<option value="${s.serviceKey}">${esc(s.serviceName)}</option>`).join('');
    const subSel = wrap.querySelector('.subType');

    function resetServiceUI(){
      svc.hours = 1; svc.units = 1; svc.complexity = 'simple'; svc.audio = null; svc.addons = {}; svc.addonHours = {};
      ['.hours','.units','.headshots'].forEach(sel=>{ const el=wrap.querySelector(sel); if(el){ el.value=1; el.required=false; }});
      const filmEl=wrap.querySelector('.filmSlider'); if(filmEl){ filmEl.value=1; updateSliderFill(filmEl); }
      const help=wrap.querySelector('.help'); if(help) help.textContent='';
      wrap.querySelectorAll(`input[name="audio-${svc.id}"]`).forEach(r=>{ r.checked=false; r.required=false; });
        const hide = sel => { const el=wrap.querySelector(sel); if(el) el.style.display='none'; };
      hide('.addonsWrap'); wrap.querySelector('.addonsList').innerHTML='';
      hide('.complexityWrap'); hide('.filmLenWrap'); hide('.qtyRow'); hide('.headshotRow'); hide('.audioWrap');
      const dateEl=wrap.querySelector('.date'); if(dateEl){ dateEl.value=''; dateEl.required=false; }
      const timeEl=wrap.querySelector('.time'); if(timeEl){ timeEl.value=''; timeEl.required=false; }
      const locEl=wrap.querySelector('.location'); if(locEl){ locEl.value=''; locEl.required=false; }
      hide('.eventRow'); hide('.locationRow');
    }

    function refreshSubs(){
      const key = typeSel.value;
      const subs = (CONFIG.catalog.pricing||[]).filter(p=>p.serviceKey===key);
      subSel.innerHTML = '<option value="" disabled selected>Select a service</option>' + subs.map(s=>`<option value="${s.offeringId}">${esc(s.subType)}</option>`).join('');
      subSel.disabled = false; 
      svc.serviceKey = key; 
      svc.subType = ''; 
      svc.offeringId = '';
      resetServiceUI(); 
      updateQuote(); 
      updateSubmitState(); 
      sendHeight();
    }

    function renderComplexity(meta){
      const compWrap = wrap.querySelector('.complexityWrap');
      const compSel = wrap.querySelector('.complexity');
      const help    = wrap.querySelector('.help');
      if (serviceEligibleForComplexity(meta)){
        compWrap.style.display='';
        const opts = [];
        if (meta.complexityBase?.simple   != null) opts.push('<option value="simple">Simple</option>');
        if (meta.complexityBase?.moderate != null) opts.push('<option value="moderate">Moderate</option>');
        if (meta.complexityBase?.complex  != null) opts.push('<option value="complex">Complex</option>');
        compSel.innerHTML = opts.join('');
        compSel.value = opts[0]?.match(/value="(.*?)"/)?.[1] || 'simple';
        svc.complexity = compSel.value;
        const text = meta.complexityTexts?.[svc.complexity] || '';
        help.textContent = text;
        compSel.onchange = ()=>{ svc.complexity = compSel.value; help.textContent = meta.complexityTexts?.[svc.complexity] || ''; updateQuote(); };
      } else {
        compWrap.style.display='none';
        svc.complexity = 'simple';
      }
    }

    function applicableAddons(meta){
      const cat = (meta.serviceKey||'').toLowerCase();
      const off = meta.offeringId;
      return (CONFIG.catalog.addons||[]).filter(a=>{
        const byCat = (a.appliesToCategories||[]).map(x=>String(x).toLowerCase()).includes(cat);
        const byOff = (a.appliesToOfferings||[]).includes(off);
        return byCat || byOff;
      });
    }

    function renderAddons(meta){
      const list = wrap.querySelector('.addonsList');
      list.innerHTML='';
      const adds = applicableAddons(meta);
      if (!adds.length){ wrap.querySelector('.addonsWrap').style.display='none'; return; }
      wrap.querySelector('.addonsWrap').style.display='';

      adds.forEach(ad=>{
        const row = document.createElement('div');
        row.className = 'grid md:grid-cols-2 gap-3 items-end';
        row.dataset.addonId = ad.id;

        const label = document.createElement('div');
        label.innerHTML = `
          <div class="lbl">${esc(ad.label)}</div>
          <div class="text-xs text-gray-600">Pricing: ${esc(ad.pricingMode)}${ad.rate?` @ ${money(ad.rate)}`:''}</div>
        `;
        row.appendChild(label);

        let control;
        const mode = (ad.selectionMode||'boolean').toLowerCase();
        if (mode==='integer'){
          control = document.createElement('label'); control.className='block';
          const max = Number(ad.maxQty)||2; const opts = Array.from({length:max+1},(_,i)=>`<option value="${i}">${i}</option>`).join('');
          control.innerHTML = `<span class="lbl">Quantity</span><select class="inp addonQty">${opts}</select>`;
        } else if (mode==='string'){
          control = document.createElement('label'); control.className='block';
          control.innerHTML = `<span class="lbl">Details</span><input type="text" class="inp addonText" placeholder="Enter details" />`;
        } else {
          control = document.createElement('label'); control.className='inline-flex items-center gap-2';
          control.innerHTML = `<input type="checkbox" class="addonBool" /><span>Include</span>`;
        }
        row.appendChild(control);

        // For per-minute services that need hours estimate â€" except Additional Camera which inherits service hours
        if (meta.priceUnit==='perMinute' && ad.needsHoursForPerMinute && String(ad.label||'').toLowerCase()!=='additional camera'){
          const hoursWrap = document.createElement('label'); hoursWrap.className='block';
          hoursWrap.innerHTML = `<span class="lbl">Estimated shoot hours</span><input type="number" min="1" value="1" class="inp addonHours" />`;
          row.appendChild(hoursWrap);
        }

        list.appendChild(row);

        const updateVals = ()=>{
          const qtySel = row.querySelector('.addonQty');
          const txt    = row.querySelector('.addonText');
          const chk    = row.querySelector('.addonBool');
          const hrs    = row.querySelector('.addonHours');
          if (qtySel) svc.addons[ad.id] = Number(qtySel.value||0);
          else if (txt) svc.addons[ad.id] = txt.value || '';
          else if (chk) svc.addons[ad.id] = chk.checked ? 1 : 0;
          if (hrs) svc.addonHours[ad.id] = Math.max(1, Number(hrs.value)||1);
          updateQuote();
        };
        row.addEventListener('input', updateVals);
        row.addEventListener('change', updateVals);
      });
    }

    function toggleForSub(){
      const meta = (CONFIG.catalog.pricing||[]).find(p=>p.offeringId===svc.offeringId);
      if (!meta){ resetServiceUI(); updateSubmitState(); sendHeight(); return; }

      // Basic flags
      const unit = meta.priceUnit || 'flat';
      const isEvent = !!meta.isEvent;

      // Event basics
      wrap.querySelector('.eventRow').style.display = isEvent ? '' : 'none';
      wrap.querySelector('.locationRow').style.display = isEvent ? '' : 'none';
      wrap.querySelector('.date').required = isEvent;
      wrap.querySelector('.time').required = isEvent;
      wrap.querySelector('.location').required = isEvent;

      // Quantities
      wrap.querySelector('.qtyRow').style.display = (unit==='perHour' || unit==='perMinute') ? '' : 'none';
      wrap.querySelector('.hoursWrap').style.display = (unit==='perHour') ? '' : 'none';
      wrap.querySelector('.filmLenWrap').style.display = (unit==='perMinute') ? '' : 'none';
      wrap.querySelector('.headshotRow').style.display = (unit==='perHeadshot') ? '' : 'none';
      wrap.querySelector('.hours').required = (unit==='perHour');
      const unitsEl = wrap.querySelector('.units'); if (unitsEl) unitsEl.required = (unit==='perMinute');
      const headEl = wrap.querySelector('.headshots'); if (headEl) headEl.required = (unit==='perHeadshot');

      if (unit==='perHeadshot'){ const h = wrap.querySelector('.headshots'); if (h){ svc.units = Math.max(1, Number(h.value)||1); } }

      // Complexity
      renderComplexity(meta);

      // Audio
      const showAudio = !!meta.showAudioOption;
      wrap.querySelector('.audioWrap').style.display = showAudio ? '' : 'none';
      wrap.querySelectorAll(`input[name="audio-${svc.id}"]`).forEach(r=> r.required = showAudio);

      // Add-ons
      renderAddons({ ...meta, offeringId: svc.offeringId });

      const fs = wrap.querySelector('.filmSlider'); if (fs) updateSliderFill(fs);
      updateSubmitState(); sendHeight();
    }

    // Listeners
    typeSel.addEventListener('change', () => { refreshSubs(); });
    subSel.addEventListener('change', () => {
      const offId = subSel.value;
      const meta = (CONFIG.catalog.pricing||[]).find(p=>p.offeringId===offId);
      svc.offeringId = offId; svc.serviceKey = meta?.serviceKey||''; svc.subType = meta?.subType||'';
      toggleForSub(); updateQuote(); updateSubmitState();
    });
    refreshSubs();

    // Qty & length - add validation triggers
    wrap.querySelector('.hours').addEventListener('input', (e)=>{ svc.hours = Math.max(1, Number(e.target.value)||1); updateQuote(); updateSubmitState(); });
    const filmSlider = wrap.querySelector('.filmSlider');
    const unitsInput = wrap.querySelector('.units');
    if (filmSlider){ updateSliderFill(filmSlider); filmSlider.addEventListener('input',(e)=>{ svc.units = Number(e.target.value)||1; if (unitsInput) unitsInput.value = svc.units; updateSliderFill(filmSlider); updateQuote(); updateSubmitState(); }); }
    if (unitsInput){ unitsInput.addEventListener('input',(e)=>{ svc.units = Number(e.target.value)||1; if (filmSlider){ filmSlider.value = svc.units; updateSliderFill(filmSlider); } updateQuote(); updateSubmitState(); }); }
    const headshotsInput = wrap.querySelector('.headshots');
    if (headshotsInput){ headshotsInput.addEventListener('input', (e)=>{ svc.units = Math.max(1, Number(e.target.value)||1); updateQuote(); updateSubmitState(); }); }

    // Date/time/location - add validation triggers
    wrap.querySelector('.date').addEventListener('change', e=>{ svc.date = e.target.value; updateQuote(); updateSubmitState(); });
    wrap.querySelector('.time').addEventListener('change', e=>{ svc.time = e.target.value; updateQuote(); updateSubmitState(); });
    wrap.querySelector('.location').addEventListener('input', e=>{ svc.location = e.target.value; updateQuote(); updateSubmitState(); });

    // Audio choice - add validation trigger
    wrap.querySelectorAll(`input[name="audio-${svc.id}"]`).forEach(r=> r.addEventListener('change', (e)=>{ svc.audio = e.target.value; updateQuote(); updateSubmitState(); }));

    // Remove card
    const removeBtn = wrap.querySelector('.remove');
    if (removeBtn){ removeBtn.addEventListener('click', ()=>{ state.services = state.services.filter(x=>x.id!==svc.id); wrap.remove(); updateQuote(); updateSubmitState(); sendHeightImmediate(); }); }

    return wrap;
  }

  // -------- PRICING --------
  function addonCostForService(meta, svc){
    const adds = (CONFIG.catalog.addons||[]).filter(a=>{
      const byCat = (a.appliesToCategories||[]).map(x=>String(x).toLowerCase()).includes((meta.serviceKey||'').toLowerCase());
      const byOff = (a.appliesToOfferings||[]).includes(meta.offeringId);
      return byCat || byOff;
    });
    let total=0; const lines=[];
    adds.forEach(ad=>{
      const val = svc.addons[ad.id];
      const hasVal = (ad.selectionMode==='boolean') ? !!val : (ad.selectionMode==='integer' ? (Number(val)||0) > 0 : !!val);
      if (!hasVal) return;
      let qty = 1;
      if (ad.selectionMode==='integer') qty = Math.min(Math.max(0, Number(val)||0), Number(ad.maxQty)||99);
      if (ad.selectionMode==='string') qty = 0; // informational only

      let cost = 0; let desc = ad.label;
      const mode = (ad.pricingMode||'flat');
      if (mode==='flat'){ 
        cost = (ad.rate||0) * qty; 
        if (qty > 1) {
          desc += ` ${money(ad.rate)} each × ${qty}`;
        } else {
          desc += ` (flat rate)`;
        }
      }
      else if (mode==='perHour'){
        const inherit = String(ad.label||'').toLowerCase()==='additional camera';
        const hrs = inherit ? (Number(svc.hours)||1) : (meta.priceUnit==='perHour' ? (Number(svc.hours)||1) : (Number(svc.addonHours[ad.id])||1));
        cost = (ad.rate||0) * qty * hrs; 
        if (qty > 1) {
          desc += ` ${money(ad.rate)}/hour × ${qty} × ${hrs} hour${hrs !== 1 ? 's' : ''}`;
        } else {
          desc += ` ${money(ad.rate)}/hour for ${hrs} hour${hrs !== 1 ? 's' : ''}`;
        }
      }
      else if (mode==='perMinute'){
        const mins = (Number(svc.units)||1);
        cost = (ad.rate||0) * qty * mins; 
        if (qty > 1) {
          desc += ` ${money(ad.rate)}/minute × ${qty} × ${mins} minute${mins !== 1 ? 's' : ''}`;
        } else {
          desc += ` ${money(ad.rate)}/minute for ${mins} minute${mins !== 1 ? 's' : ''}`;
        }
      }
      if (cost>0) { lines.push({label: desc, cost}); total += cost; }
    });
    return { total, lines };
  }

  function baseCostForService(meta, svc){
    const unit = meta.priceUnit || 'flat';
    let baseRate = Number(meta.basePrice)||0;
    if (meta.complexityBase && serviceEligibleForComplexity(meta)){
      baseRate = Number(meta.complexityBase[svc.complexity] ?? baseRate) || 0;
    }
    const qty = unit==='perHour' ? (Number(svc.hours)||1)
              : unit==='perMinute' ? (Number(svc.units)||1)
              : unit==='perHeadshot' ? (Number(svc.units)||1)
              : 1;
    let base = baseRate * ((unit==='perHour'||unit==='perMinute'||unit==='perHeadshot') ? qty : 1);
    const lines = [];

    // Create natural language descriptions
    let baseLabel = esc(meta.subType || 'Service');
    if (unit === 'perHour') {
      baseLabel += ` ${money(baseRate)}/hour for ${qty} hour${qty !== 1 ? 's' : ''}`;
    } else if (unit === 'perMinute') {
      baseLabel += ` ${money(baseRate)}/minute for ${qty} minute${qty !== 1 ? 's' : ''}`;
    } else if (unit === 'perHeadshot') {
      baseLabel += ` ${money(baseRate)} per headshot × ${qty} headshot${qty !== 1 ? 's' : ''}`;
    } else {
      baseLabel += ' (flat rate)';
    }
    
    lines.push({label: baseLabel, cost: base});

    // Setup time (hours -> charge base hourly rate * setupTime) for videography hourly
    let setupFee = 0;
    if (isVideography(meta) && unit==='perHour' && Number(meta.setupTime)>0){
      setupFee = (Number(meta.basePrice)||0) * Number(meta.setupTime);
      if (setupFee>0) {
        const setupLabel = `Setup & breakdown ${money(meta.basePrice)}/hour for ${money(meta.setupTime)} hour${Number(meta.setupTime) !== 1 ? 's' : ''}`;
        lines.push({label: setupLabel, cost: setupFee});
      }
    }

    if (meta.studioRequired) lines.push({label: 'Studio rental (billed separately)', cost: 0});

    return { base, setupFee, lines };
  }

  function costForService(svc){
    const meta = (CONFIG.catalog.pricing||[]).find(p=>p.offeringId===svc.offeringId);
    if (!meta) return { subtotal:0, lines:[], chartData: [] };

    const base = baseCostForService(meta, svc);
    const addons = addonCostForService({ ...meta, offeringId: svc.offeringId }, svc);

    const subtotal = base.base + base.setupFee + addons.total;
    const lines = [...base.lines, ...addons.lines];
    
    // Create chart data from cost lines
    const chartData = lines.filter(line => line.cost > 0).map(line => ({
      label: line.label,
      value: line.cost
    }));
    
    return { subtotal, lines, chartData };
  }

  function updateQuote(){
    const breakdown = []; 
    const chartData = [];
    let grand = 0;
    
    state.services.forEach((svc, idx)=>{
      if (!svc.offeringId) return;
      const res = costForService(svc);
      grand += res.subtotal; 
      
      // Add service prefix for multiple services
      const prefix = idx > 0 ? `Service ${idx + 1}: ` : '';
      
      res.lines.forEach(line => {
        const displayText = `${prefix}${line.label}: ${money(line.cost)}${line.cost === 0 ? '' : ''}`;
        breakdown.push(displayText);
        
        if (line.cost > 0) {
          chartData.push({
            label: `${prefix}${line.label}`,
            value: line.cost
          });
        }
      });
    });

    if (grand === 0){ 
      $('#quoteTotal').textContent = '$0.00'; 
      $('#quoteBreakdown').innerHTML = '<div class="text-gray-500">â€"</div>';
      // Clear chart but show background ring
      const canvas = document.getElementById('donutChart');
      if (canvas) createDonutChart(canvas, []);
      updateSubmitState(); sendHeight(); return; 
    }
    
    const best = bestDiscountPercent(); 
    let discountAmount = 0;
    if (best > 0) {
      discountAmount = grand * (best / 100);
      breakdown.push(`Discount (${best}%): -${money(discountAmount)}`);
    }
    
    const total = Math.max(0, grand * (1 - best/100));
    $('#quoteTotal').textContent = `${money(total)}`;
    
    // Create breakdown with color indicators
    const coloredBreakdown = breakdown.map((line, idx) => {
      const isDiscount = line.includes('Discount');
      const hasChartData = chartData[idx] && !isDiscount;
      
      let color = '#6b7280'; // Default grey
      if (isDiscount) {
        color = '#10b981'; // Green for discount
      } else if (hasChartData) {
        color = CHART_COLORS[idx % CHART_COLORS.length];
      }
      
      const textColor = isDiscount ? 'text-green-600' : '';
      
      // Parse the line to separate description and cost
      const parts = line.split(': ');
      if (parts.length === 2 && !isDiscount) {
        const description = parts[0];
        const cost = parts[1];
        return `<div class="flex items-center justify-between gap-2">
          <div class="flex items-center gap-2 flex-1">
            <div class="w-3 h-3 rounded-full flex-shrink-0" style="background-color: ${color}"></div>
            <span class="text-sm">${esc(description)}</span>
          </div>
          <span class="text-sm font-medium text-right">${cost}</span>
        </div>`;
      } else {
        // Handle discount lines and other special cases
        return `<div class="flex items-center gap-2">
          <div class="w-3 h-3 rounded-full flex-shrink-0" style="background-color: ${color}"></div>
          <span class="text-sm ${textColor}">${esc(line)}</span>
        </div>`;
      }
    }).join('');
    
    $('#quoteBreakdown').innerHTML = coloredBreakdown;
    
    // Update donut chart (always call to ensure background ring is drawn)
    const canvas = document.getElementById('donutChart');
    if (canvas) {
      createDonutChart(canvas, chartData);
    }
    
    updateSubmitState(); sendHeight();
  }

  function updateSubmitState(){
    const btn = document.getElementById('submitBtn');
    if (btn && btn.dataset.loading==='1') return;
    
    // Manual validation check - more reliable than checkValidity()
    const errors = [];
    
    // Check basic identity fields
    const firstName = document.getElementById('firstNameInput').value.trim();
    const lastName = document.getElementById('lastNameInput').value.trim();
    const email = document.getElementById('emailInput').value.trim();
    
    if (!firstName) errors.push('First name required');
    if (!lastName) errors.push('Last name required');
    if (!email) errors.push('Email required');
    if (email && !email.includes('@')) errors.push('Valid email required');
    
    // Check required checkboxes
    const tosCheck = document.getElementById('tosCheck');
    const understandCheck = document.getElementById('understandCheck');
    if (!tosCheck.checked) errors.push('Terms of Service agreement required');
    if (!understandCheck.checked) errors.push('Booking acknowledgment required');
    
    // Check each service for completeness
    state.services.forEach((svc, idx) => {
      const serviceLabel = idx === 0 ? 'Primary service' : `Service ${idx + 1}`;
      
      // Check if service type and subtype are selected
      if (!svc.serviceKey) errors.push(`${serviceLabel}: Service type required`);
      if (!svc.offeringId) errors.push(`${serviceLabel}: Service selection required`);
      
      if (svc.offeringId) {
        const meta = (CONFIG.catalog.pricing||[]).find(p=>p.offeringId===svc.offeringId);
        if (meta) {
          const unit = meta.priceUnit || 'flat';
          const isEvent = !!meta.isEvent;
          const showAudio = !!meta.showAudioOption;
          
          // Check event-specific requirements
          if (isEvent) {
            if (!svc.date) errors.push(`${serviceLabel}: Date required`);
            if (!svc.time) errors.push(`${serviceLabel}: Time required`);
            if (!svc.location.trim()) errors.push(`${serviceLabel}: Location required`);
          }
          
          // Check quantity requirements
          if (unit === 'perHour' && (!svc.hours || svc.hours < 1)) {
            errors.push(`${serviceLabel}: Hours required`);
          }
          if (unit === 'perMinute' && (!svc.units || svc.units < 0.5)) {
            errors.push(`${serviceLabel}: Film length required`);
          }
          if (unit === 'perHeadshot' && (!svc.units || svc.units < 1)) {
            errors.push(`${serviceLabel}: Number of headshots required`);
          }
          
          // Check audio requirement
          if (showAudio && !svc.audio) {
            errors.push(`${serviceLabel}: Audio recording choice required`);
          }
        }
      }
    });
    
    // Update button state
    if (errors.length === 0) { 
      btn.disabled = false; 
      btn.classList.remove('btn-disabled'); 
      btn.classList.add('btn-primary'); 
      btn.textContent = 'Submit Request'; 
    } else { 
      btn.disabled = true; 
      btn.classList.add('btn-disabled'); 
      btn.classList.remove('btn-primary'); 
      
      // Show most relevant error
      if (errors.some(e => e.includes('First name') || e.includes('Last name') || e.includes('Email'))) {
        btn.textContent = 'Complete your info to continue';
      } else if (errors.some(e => e.includes('Terms') || e.includes('acknowledgment'))) {
        btn.textContent = 'Accept terms to continue';
      } else if (errors.some(e => e.includes('Service type') || e.includes('Service selection'))) {
        btn.textContent = 'Select services to continue';
      } else {
        btn.textContent = 'Complete service details to continue';
      }
    }
  }

  function addServiceCard(isPrimary=false){
    const id = isPrimary ? 'primary' : uid();
    const svc = createServiceState(id);
    state.services.push(svc);
    const card = buildServiceCard(svc);
    document.getElementById('servicesContainer').appendChild(card);
  }

  document.addEventListener('DOMContentLoaded', async ()=>{
    // 1) Load catalog or show fatal
    try{
      const ok = await loadCatalog();
      if (!ok || !CONFIG.catalog) throw new Error('Catalog failed');
    }catch(err){
      console.error('Catalog load failed', err);
      renderFatal('Our system can\'t load the services catalog right now.');
      return;
    }

    // 2) Build primary service card
    addServiceCard(true);

    // 3) Setup height observers - IMPROVED VERSION
    try {
      // Use ResizeObserver for better performance
      if (window.ResizeObserver) {
        const ro = new ResizeObserver(() => sendHeightDebounced());
        
        // Observe the main container
        const container = document.querySelector('.max-w-4xl');
        if (container) ro.observe(container);
        
        // Observe dynamic content containers
        const servicesContainer = document.getElementById('servicesContainer');
        if (servicesContainer) ro.observe(servicesContainer);
      }

      // Use debounced version for input events
      document.addEventListener('input', sendHeightDebounced);
      document.addEventListener('change', sendHeightDebounced);
      
      // Handle window events
      window.addEventListener('resize', sendHeightDebounced);
      
      // Send initial height
      setTimeout(() => sendHeightImmediate(), 100);
      setTimeout(() => sendHeightImmediate(), 300);
      
    } catch(e) {
      console.warn('Height observer setup failed:', e);
      // Fallback to periodic height checks
      setInterval(sendHeight, 1000);
    }

    // 4) Discount listeners
    document.querySelectorAll('input[name="selfDiscount"]').forEach(r=> r.addEventListener('change', ()=>{ updateQuote(); }));

    // 4.5) Add validation listeners for identity fields and checkboxes
    document.getElementById('firstNameInput').addEventListener('input', updateSubmitState);
    document.getElementById('lastNameInput').addEventListener('input', updateSubmitState);
    document.getElementById('emailInput').addEventListener('input', updateSubmitState);
    document.getElementById('tosCheck').addEventListener('change', updateSubmitState);
    document.getElementById('understandCheck').addEventListener('change', updateSubmitState);

    // 5) Add another service
    document.getElementById('addServiceBtn').addEventListener('click', ()=>{ 
      addServiceCard(false); 
      updateQuote(); 
      updateSubmitState(); 
      // Use immediate height update for major layout changes
      setTimeout(() => sendHeightImmediate(), 50);
    });

    // 6) Form validation hooks
    const formEl = document.getElementById('intakeForm');
    formEl.addEventListener('input', updateSubmitState);
    formEl.addEventListener('change', updateSubmitState);

    // 7) Submit
    document.getElementById('intakeForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const btn = document.getElementById('submitBtn');
      if (btn && btn.dataset.loading === '1') return;
      if (!e.target.checkValidity()){ updateSubmitState(); return; }

      if (btn){ btn.dataset.loading = '1'; btn.disabled = true; btn.classList.add('btn-disabled','btn-loading'); btn.classList.remove('btn-primary'); btn.innerHTML = '<svg class="spinner" viewBox="0 0 24 24" fill="none" aria-hidden="true"><circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="4" opacity=".25"></circle><path d="M21 12a9 9 0 0 1-9 9" stroke="currentColor" stroke-width="4"></path></svg><span>Submittingâ€¦</span>'; }

      const primary = state.services[0] || {}; const meta = (CONFIG.catalog.pricing||[]).find(p=>p.offeringId===primary.offeringId) || {}; const unit = meta.priceUnit || 'flat';
      const payload = {
        firstName: document.getElementById('firstNameInput').value,
        lastName: document.getElementById('lastNameInput').value,
        email: document.getElementById('emailInput').value.trim().toLowerCase(),
        organizationName: document.getElementById('orgInput')?.value || '',
        discountCategory: (document.querySelector('input[name="selfDiscount"]:checked')?.value || 'none'),
        discountAppliedPercent: bestDiscountPercent(),
        mailingOptIn: (document.querySelector('input[name="mailing"]:checked')?.value === 'yes'),
        additionalInfo: document.getElementById('additionalInfo')?.value || '',
        requestedProviders: document.getElementById('requestedProviders')?.value || '',
        services: state.services,
        quoteTotal: document.getElementById('quoteTotal').textContent,
        quoteBreakdown: document.getElementById('quoteBreakdown').innerText,
        primaryDateTime: combineDateTime(primary.date, primary.time),
        primaryEndTime: (unit==='perHour' && primary.time && primary.hours) ? addHoursToTime(primary.time, primary.hours) : '',
        primaryVenue: primary.location || '',
        primaryServiceType: meta.subType || '',
        needsAudioRecording: (isVideography(meta) && !isVideoEditing(meta)) ? (primary.audio==='yes' ? 'Yes, please record audio' : (primary.audio==='no' ? 'No audio required' : '')) : '',
        tosAccepted: !!document.getElementById('tosCheck')?.checked,
        bookingAcknowledge: !!document.getElementById('understandCheck')?.checked
      };

      try{
        const url = `${CONFIG.api.baseUrl}${CONFIG.api.webhookPath}`;
        const res = await fetch(url, { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payload) });
        if (!res.ok) throw new Error(`Submit failed: ${res.status}`);

        // Hide form elements
        document.getElementById('identityCard').style.display = 'none';
        document.getElementById('intakeForm').style.display = 'none';
        
        const success = document.getElementById('successScreen');
        if (success){
          const who = document.getElementById('firstNameInput')?.value || 'Thank you';
          document.getElementById('successRef').textContent = new Date().toLocaleString();
          success.querySelector('h2').innerHTML = `Thanks, ${esc(who)} â€" your request was sent!`;
          success.style.display = 'block';
        }
        
        // CRITICAL: Use immediate height update for success screen
        sendHeightImmediate();
        
        // Send success message with height
        setTimeout(() => {
          const nowH = measureHeight();
          (ALLOWED_PARENTS||[]).forEach(origin=>{ 
            try{ 
              window.parent.postMessage({ type:'ODD_FORM_SUCCESS', height: nowH, ts: Date.now() }, origin); 
            }catch(_){/*noop*/} 
          });
        }, 100);
        
      }catch(err){ 
        console.error(err); 
        alert('Sorry, something went wrong sending your request. Please try again.'); 
      }
      finally{
        if (btn){ btn.dataset.loading = '0'; btn.disabled = true; btn.classList.add('btn-disabled'); btn.classList.remove('btn-primary','btn-loading'); btn.textContent = 'Submit Request'; }
        updateSubmitState();
      }
    });

    updateSubmitState();
    
    // Add periodic validation check to catch any edge cases
    setInterval(updateSubmitState, 1000);
    
    // Initialize chart with background ring
    const canvas = document.getElementById('donutChart');
    if (canvas) createDonutChart(canvas, []);
    
    // Final initial height
    sendHeightImmediate();
  });
  </script>
</body>
</html>
