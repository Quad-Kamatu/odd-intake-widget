<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Odd Embeddable Intake Widget</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --c1:#FF9D76; /* coral */
      --c2:#76F1FF; /* cyan */
      --c3:#C176FF; /* violet */
      --c4:#FFE176; /* saffron */
    }

    @property --ang { syntax: '<angle>'; inherits: false; initial-value: 0deg; }

    html, body { height: 100%; margin:0; padding:0; background:transparent; }
    body{ color:#111; position:relative; }

    /* Fluid, shifting gradient background */
    html::before{
      content:"";
      position:fixed; left:0; top:0; right:0; bottom:0; width:100vw; height:100vh; z-index:-1;
      background: linear-gradient(var(--ang), var(--c1), var(--c2), var(--c3), var(--c4));
      background-size: 200% 200%;
      animation: bg-pan 18s ease-in-out infinite alternate, bg-rotate 36s linear infinite;
      filter: saturate(1.03);
      pointer-events:none;
    }

    @keyframes bg-pan { 0%{background-position:0% 0%} 50%{background-position:100% 0%} 100%{background-position:0% 100%} }
    @keyframes bg-rotate { to { --ang: 360deg; } }
    @media (prefers-reduced-motion: reduce){ body::before{ animation:none; } }

    .card{ box-shadow:0 8px 20px rgba(0,0,0,.06); border-radius:16px; background:#fff; padding:24px; border:1px solid #eaeaea; }
    .lbl{ font-size:0.9rem; font-weight:600; color:#222; }
    .inp{ width:100%; margin-top:4px; border:1px solid #ddd; border-radius:12px; padding:10px 12px; outline:none; }
    .inp:focus{ border-color:#111; box-shadow:0 0 0 2px rgba(0,0,0,.08); }
    .row{ display:grid; grid-template-columns:1fr; gap:16px; }
    @media(min-width:768px){ .row{ grid-template-columns:1fr 1fr; } }
    .btn{ display:inline-flex; align-items:center; justify-content:center; border-radius:12px; padding:10px 14px; font-weight:700; border:1px solid #222; transition: background-color .18s ease, color .18s ease, border-color .18s ease; }
    .btn-primary, .btn-primary:link, .btn-primary:visited{ background:#FF9D76 !important; border-color:#FF9D76 !important; color:#fff !important; }
    .btn-primary:hover, .btn-primary:focus, .btn-primary:focus-visible, .btn-primary:active{ background:#76F1FF !important; border-color:#76F1FF !important; color:#111 !important; }
    .btn-disabled{ background:#e5e7eb; border-color:#d1d5db; color:#9ca3af; cursor:not-allowed; }
    .badge{ display:inline-block; border-radius:9999px; font-size:.85rem; padding:6px 10px; border:1px solid #ccc; background:#f3f3f3; color:#111; }
    .mono{ font-variant-numeric: tabular-nums; }
    .muted{ opacity:.6; }
    a.link{ color:#111; text-decoration:underline; }
    .service-card{ border:1px dashed #e5e7eb; border-radius:16px; padding:16px; }
    .page-title, .page-subtitle{ color:#fff; text-shadow:0 1px 2px rgba(0,0,0,.25); }

    /* Film length slider styles */
    .filmSlider{ --val:0%; accent-color:#76F1FF; height:2rem; width:100%; background:linear-gradient(to right, #76F1FF 0%, #76F1FF var(--val), #dbeafe var(--val), #dbeafe 100%); border-radius:9999px; }
    .filmSlider:focus{ outline:none; }
    .filmSlider::-webkit-slider-runnable-track{ height:6px; border-radius:9999px; background:linear-gradient(to right, #76F1FF 0%, #76F1FF var(--val), #dbeafe var(--val), #dbeafe 100%); }
    .filmSlider::-webkit-slider-thumb{ -webkit-appearance:none; appearance:none; width:18px; height:18px; border-radius:9999px; background:#76F1FF; border:2px solid #76F1FF; margin-top:-6px; box-shadow:0 1px 2px rgba(0,0,0,.15); }
    .filmSlider:focus::-webkit-slider-thumb{ box-shadow:0 0 0 4px rgba(118,241,255,.25); }
    .filmSlider::-moz-range-track{ height:6px; border-radius:9999px; background:#dbeafe; }
    .filmSlider::-moz-range-progress{ height:6px; border-radius:9999px; background:#76F1FF; }
    .filmSlider::-moz-range-thumb{ width:18px; height:18px; border-radius:9999px; background:#76F1FF; border:2px solid #76F1FF; box-shadow:0 1px 2px rgba(0,0,0,.15); }

    .service-card .row,
    .service-card .eventRow,
    .service-card .locationRow,
    .service-card .qtyRow,
    .service-card .headshotRow,
    .service-card .complexityWrap,
    .service-card .audioWrap,
    .service-card .addonsWrap{ margin-bottom:16px; }
    .service-card .filmLenWrap{ margin-bottom:12px; }
    .service-card .complexityWrap .help{ margin-top:8px; }
    .service-card > :last-child{ margin-bottom:0 !important; }

    @keyframes spin{ to{ transform: rotate(360deg); } }
    .spinner{ width:1rem; height:1rem; display:inline-block; animation: spin 1s linear infinite; margin-right:.5rem; vertical-align:middle; }
    .btn.btn-loading{ cursor:progress; }

    /* Enhanced addon styling */
    .addon-selected { 
      background: #f0f9ff; 
      border-color: #76F1FF !important; 
    }
    .addon-row {
      padding: 12px;
      border-radius: 8px;
      transition: all 0.2s ease;
    }
    .addon-row:hover {
      background: #f8f9fa;
    }
  </style>
</head>
<body>

<div class="mx-auto max-w-4xl p-6">
  <div class="mb-6">
    <h1 class="page-title text-3xl font-bold mb-2">Service Request</h1>
  </div>

  <form id="intakeForm">
    <!-- Basic Info Card -->
    <div class="card mb-6">
      <h2 class="text-xl font-bold mb-4">Your Info</h2>
      <div class="row">
        <label class="block">
          <span class="lbl">First Name *</span>
          <input type="text" id="firstNameInput" class="inp" required />
        </label>
        <label class="block">
          <span class="lbl">Last Name *</span>
          <input type="text" id="lastNameInput" class="inp" required />
        </label>
      </div>
      <div class="row">
        <label class="block">
          <span class="lbl">Email *</span>
          <input type="email" id="emailInput" class="inp" required />
        </label>
        <label class="block">
          <span class="lbl">Organization Name (optional)</span>
          <input type="text" id="orgInput" class="inp" />
        </label>
      </div>
    </div>

    <!-- Discount Card -->
    <div class="card mb-6">
      <h2 class="text-lg font-bold mb-3">Discount Qualification</h2>
      <p class="text-sm text-gray-600 mb-3">Do you qualify for one of these discounts? (select one)</p>
      <div class="space-y-2">
        <label class="inline-flex items-center gap-2">
          <input type="radio" name="selfDiscount" value="none" checked />
          <span>None</span>
        </label>
        <label class="inline-flex items-center gap-2">
          <input type="radio" name="selfDiscount" value="student" />
          <span>Student - 10% (show student ID)</span>
        </label>
        <label class="inline-flex items-center gap-2">
          <input type="radio" name="selfDiscount" value="nonprofit" />
          <span>501(c)(3) or fiscally sponsored - 10%</span>
        </label>
        <label class="inline-flex items-center gap-2">
          <input type="radio" name="selfDiscount" value="artist" />
          <span>ODD Artist - 20%</span>
        </label>
      </div>
    </div>

    <!-- Services Section -->
    <div class="card mb-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-bold">Services</h2>
        <button type="button" id="addServiceBtn" class="btn btn-primary text-sm">+ Add another service</button>
      </div>
      <div id="servicesContainer">
        <!-- Services will be dynamically added here -->
      </div>
    </div>

    <!-- Quote Section -->
    <div class="card mb-6">
      <h2 class="text-lg font-bold mb-3">Estimate</h2>
      <div class="mb-3">
        <h3 class="font-semibold">Quote Breakdown</h3>
        <div id="quoteBreakdown" class="text-sm text-gray-600 mono whitespace-pre-wrap"></div>
      </div>
      <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
        <span class="font-bold">Total</span>
        <span id="quoteTotal" class="font-bold text-lg mono">$0</span>
      </div>
    </div>

    <!-- Additional Info -->
    <div class="card mb-6">
      <div class="row">
        <label class="block">
          <span class="lbl">Additional relevant information</span>
          <textarea id="additionalInfo" class="inp" rows="3" placeholder="Any special requirements, preferences, or details we should know about..."></textarea>
        </label>
        <label class="block">
          <span class="lbl">Requested providers (optional)</span>
          <input type="text" id="requestedProviders" class="inp" placeholder="Any specific team members you'd like to work with" />
        </label>
      </div>
    </div>

    <!-- Terms and Mailing -->
    <div class="card mb-6">
      <div class="space-y-4">
        <label class="inline-flex items-start gap-3">
          <input type="checkbox" id="tosCheck" class="mt-1" required />
          <span class="text-sm">I have read and agree to the <a href="#" class="link">Terms of Service</a> *</span>
        </label>
        <label class="inline-flex items-start gap-3">
          <input type="checkbox" id="understandCheck" class="mt-1" required />
          <span class="text-sm">I understand that submitting this form does not constitute confirmation of booking *</span>
        </label>
        <div>
          <p class="lbl mb-2">Would you like to join our mailing list to receive offers and promotions?</p>
          <label class="inline-flex items-center gap-2 mr-4">
            <input type="radio" name="mailing" value="yes" />
            <span>Yes</span>
          </label>
          <label class="inline-flex items-center gap-2">
            <input type="radio" name="mailing" value="no" checked />
            <span>No</span>
          </label>
        </div>
      </div>
    </div>

    <!-- Submit Button -->
    <div class="text-center">
      <button type="submit" id="submitBtn" class="btn btn-primary text-lg px-8">
        Submit Request
      </button>
    </div>
  </form>

  <!-- Success Message -->
  <div id="successMessage" class="card text-center" style="display:none;">
    <h2 class="text-xl font-bold text-green-600 mb-2">Thanks — your request was sent!</h2>
    <p class="text-gray-600 mb-4">We'll follow up by email shortly.</p>
    <p class="text-sm text-gray-500 mb-4">Submitted: <span id="submissionTime"></span></p>
    <button type="button" onclick="window.location.reload()" class="btn btn-primary">Return to Services</button>
  </div>

</div>

<script>
  // -------- CONFIG / CATALOG --------
  const CONFIG = {
    mode: 'api',
    api: { baseUrl: 'https://www.onedaydance.com/_functions', webhookPath: '/submit', catalogPath: '/catalog' },
    catalog: null
  };
  const ALLOWED_PARENTS = ['https://www.onedaydance.com', 'https://onedaydance.com'];

  // -------- HEIGHT MESSAGING --------
  let currentHeight = 0;
  let heightRequestId = null;

  function postHeights(px) {
    try {
      const ts = Date.now();
      const msgString = JSON.stringify({ height: px, timestamp: ts, requestId: heightRequestId });
      
      if (window.parent && window.parent !== window) {
        ALLOWED_PARENTS.forEach(origin => {
          try {
            window.parent.postMessage(msgString, origin);
          } catch (e) { /* ignore cross-origin errors */ }
        });
      }
    } catch (e) { /* ignore errors */ }
  }

  function measureHeight() {
    const body = document.body;
    const html = document.documentElement;
    return Math.max(
      body.scrollHeight, body.offsetHeight,
      html.clientHeight, html.scrollHeight, html.offsetHeight
    );
  }

  function sendHeight() {
    const height = measureHeight();
    if (height !== currentHeight) {
      currentHeight = height;
      postHeights(height);
    }
  }

  function sendHeightImmediate() {
    currentHeight = measureHeight();
    postHeights(currentHeight);
  }

  const sendHeightDebounced = (() => {
    let timeout;
    return () => {
      clearTimeout(timeout);
      timeout = setTimeout(sendHeight, 100);
    };
  })();

  // -------- UTILITIES --------
  const esc = str => (str || '').replace(/[<>&"']/g, c => ({ '<': '&lt;', '>': '&gt;', '&': '&amp;', '"': '&quot;', "'": '&#39;' })[c]);
  const money = (amt, showCents = true) => {
    const n = Number(amt) || 0;
    return showCents ? `$${n.toFixed(2)}` : `$${Math.round(n)}`;
  };

  function updateSliderFill(slider) {
    const val = Number(slider.value) || 0;
    const max = Number(slider.max) || 100;
    const percent = (val / max) * 100;
    slider.style.setProperty('--val', `${percent}%`);
  }

  function to12h(time24) {
    if (!time24) return '';
    const [h, m] = time24.split(':').map(Number);
    const ampm = h >= 12 ? 'PM' : 'AM';
    const h12 = (h % 12) || 12;
    return `${h12}:${String(m).padStart(2, '0')} ${ampm}`;
  }

  function addHoursToTime(timeStr, hours) {
    if (!timeStr || !hours) return '';
    const parts = timeStr.split(':');
    const h = parseInt(parts[0], 10) || 0;
    const m = parseInt(parts[1] || '0', 10) || 0;
    let totalMins = h * 60 + m + Math.round(Number(hours) * 60);
    totalMins = (totalMins % (24 * 60) + (24 * 60)) % (24 * 60);
    const newH = Math.floor(totalMins / 60);
    const newM = totalMins % 60;
    const ampm = newH >= 12 ? 'PM' : 'AM';
    const h12 = (newH % 12) || 12;
    return `${h12}:${String(newM).padStart(2, '0')} ${ampm}`;
  }

  function combineDateTime(date, time) {
    if (!date) return '';
    return time ? `${date} ${time}` : date;
  }

  // -------- STATE --------
  const state = { services: [] };

  // -------- CATALOG LOADING --------
  async function loadCatalog() {
    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), 10000);
    
    try {
      const url = `${CONFIG.api.baseUrl}${CONFIG.api.catalogPath}`;
      const res = await fetch(url, {
        headers: { 'Content-Type': 'application/json' },
        signal: controller.signal
      });
      
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      
      const data = await res.json();
      const normalizeKey = k => String(k || '').toLowerCase().replace(/\s+/g, '');
      
      const services = (data.services || []).map(s => ({ ...s, serviceKey: normalizeKey(s.serviceKey) }));
      const pricing = (data.pricing || []).map(p => ({ ...p, serviceKey: normalizeKey(p.serviceKey) }));
      const addons = (data.addons || []).map(a => ({
        ...a,
        appliesToCategories: (a.appliesToCategories || []).map(normalizeKey)
      }));
      
      if (!services.length || !pricing.length) throw new Error('Empty catalog');
      
      CONFIG.catalog = { services, pricing, addons };
      return true;
    } finally {
      clearTimeout(timeout);
    }
  }

  function renderFatal(message) {
    const root = document.querySelector('.max-w-4xl');
    if (!root) return;
    root.innerHTML = `
      <div class="card text-center">
        <h2 class="text-xl font-bold text-red-600 mb-2">Unable to Load Form</h2>
        <p class="text-gray-600">${esc(message)}</p>
      </div>
    `;
    sendHeightImmediate();
  }

  // -------- SERVICE MANAGEMENT --------
  function createServiceState(id) {
    return {
      id,
      offeringId: '',
      serviceKey: '',
      subType: '',
      date: '',
      time: '',
      location: '',
      hours: 1,
      units: 1,
      complexity: 'simple',
      audio: null,
      addons: {}, // Enhanced: Ensure addons object is always initialized
      addonHours: {},
      addonLabels: {} // Enhanced: Store addon labels for better webhook data
    };
  }

  function buildServiceCard(svc) {
    const wrap = document.createElement('div');
    wrap.className = 'card service-card';
    wrap.dataset.id = svc.id;
    wrap.innerHTML = `
      <div class="flex items-center justify-between mb-4">
        <h3 class="font-bold">Service ${state.services.indexOf(svc) + 1}</h3>
        ${state.services.length > 1 ? `<button type="button" class="removeService text-red-600 hover:text-red-800">Remove</button>` : ''}
      </div>
      
      <div class="row">
        <label class="block">
          <span class="lbl">Service Category *</span>
          <select class="inp serviceType" required>
            <option value="">Choose category...</option>
            ${(CONFIG.catalog.services || []).map(s => 
              `<option value="${esc(s.serviceKey)}">${esc(s.label)}</option>`
            ).join('')}
          </select>
        </label>
        <label class="block">
          <span class="lbl">Service Type *</span>
          <select class="inp subType" required disabled>
            <option value="">First select a category</option>
          </select>
        </label>
      </div>

      <!-- Event Details -->
      <div class="eventRow row" style="display:none;">
        <label class="block">
          <span class="lbl">Date</span>
          <input type="date" class="inp date" />
        </label>
        <label class="block">
          <span class="lbl">Time</span>
          <input type="time" class="inp time" />
        </label>
      </div>

      <div class="locationRow" style="display:none;">
        <label class="block">
          <span class="lbl">Venue Address</span>
          <input type="text" class="inp location" placeholder="Street address, city, state" />
        </label>
      </div>

      <!-- Quantity Controls -->
      <div class="qtyRow row" style="display:none;">
        <label class="block">
          <span class="lbl">Hours</span>
          <input type="number" min="1" class="inp hours" value="1" />
        </label>
      </div>

      <div class="headshotRow" style="display:none;">
        <label class="block">
          <span class="lbl">Number of Headshots</span>
          <input type="number" min="1" class="inp headshots" value="1" />
        </label>
      </div>

      <div class="filmLenWrap" style="display:none;">
        <label class="block">
          <span class="lbl">Film Length (minutes)</span>
          <input type="range" min="1" max="30" value="1" class="filmSlider" />
          <div class="text-center text-sm text-gray-600 mt-1">
            <span class="filmLenDisplay">1</span> minute(s)
          </div>
        </label>
      </div>

      <!-- Complexity -->
      <div class="complexityWrap" style="display:none;">
        <label class="block">
          <span class="lbl">Editing Complexity</span>
          <select class="inp complexity">
            <option value="simple">Simple</option>
            <option value="moderate">Moderate</option>
            <option value="complex">Complex</option>
          </select>
          <div class="help text-xs text-gray-600 mt-1"></div>
        </label>
      </div>

      <!-- Audio -->
      <div class="audioWrap" style="display:none;">
        <span class="lbl">Audio Recording</span>
        <div class="mt-2 space-y-1">
          <label class="inline-flex items-center gap-2">
            <input type="radio" name="audio-${svc.id}" value="yes" />
            <span>Yes, record audio</span>
          </label>
          <label class="inline-flex items-center gap-2">
            <input type="radio" name="audio-${svc.id}" value="no" />
            <span>No audio needed</span>
          </label>
        </div>
      </div>

      <!-- Enhanced Add-ons Section -->
      <div class="card bg-gray-50 border border-gray-200 addonsWrap" style="display:none;">
        <h4 class="font-bold mb-3">Add-ons</h4>
        <div class="addonsList space-y-3">
          <!-- Add-ons will be populated here -->
        </div>
      </div>
    `;

    const typeSel = wrap.querySelector('.serviceType');
    const subSel = wrap.querySelector('.subType');

    // Enhanced reset function
    function resetServiceUI() {
      svc.hours = 1;
      svc.units = 1;
      svc.complexity = 'simple';
      svc.audio = null;
      svc.addons = {};
      svc.addonHours = {};
      svc.addonLabels = {}; // Enhanced: Reset addon labels

      ['.hours', '.units', '.headshots'].forEach(sel => {
        const el = wrap.querySelector(sel);
        if (el) {
          el.value = 1;
          el.required = false;
        }
      });

      const filmEl = wrap.querySelector('.filmSlider');
      if (filmEl) {
        filmEl.value = 1;
        updateSliderFill(filmEl);
      }

      const help = wrap.querySelector('.help');
      if (help) help.textContent = '';

      wrap.querySelectorAll(`input[name="audio-${svc.id}"]`).forEach(r => {
        r.checked = false;
        r.required = false;
      });

      const hide = sel => {
        const el = wrap.querySelector(sel);
        if (el) el.style.display = 'none';
      };
      
      hide('.addonsWrap');
      wrap.querySelector('.addonsList').innerHTML = '';
      hide('.complexityWrap');
      hide('.filmLenWrap');
      hide('.qtyRow');
      hide('.headshotRow');
      hide('.audioWrap');
      
      const dateEl = wrap.querySelector('.date');
      if (dateEl) {
        dateEl.value = '';
        dateEl.required = false;
      }
      
      const timeEl = wrap.querySelector('.time');
      if (timeEl) {
        timeEl.value = '';
        timeEl.required = false;
      }
      
      const locEl = wrap.querySelector('.location');
      if (locEl) {
        locEl.value = '';
        locEl.required = false;
      }
      
      hide('.eventRow');
      hide('.locationRow');
    }

    function refreshSubs() {
      const key = typeSel.value;
      const subs = (CONFIG.catalog.pricing || []).filter(p => p.serviceKey === key);
      subSel.innerHTML = `<option value="">Choose service...</option>` +
        subs.map(p => `<option value="${esc(p.offeringId)}">${esc(p.subType)}</option>`).join('');
      subSel.disabled = !subs.length;
      resetServiceUI();
      updateSubmitState();
      sendHeight();
    }

    // Enhanced addon rendering with better data structure
    function applicableAddons(meta) {
      const cat = (meta.serviceKey || '').toLowerCase();
      const off = meta.offeringId;
      return (CONFIG.catalog.addons || []).filter(a => {
        const byCat = (a.appliesToCategories || []).map(x => String(x).toLowerCase()).includes(cat);
        const byOff = (a.appliesToOfferings || []).includes(off);
        return byCat || byOff;
      });
    }

    function renderAddons(meta) {
      const list = wrap.querySelector('.addonsList');
      list.innerHTML = '';
      const adds = applicableAddons(meta);
      
      if (!adds.length) {
        wrap.querySelector('.addonsWrap').style.display = 'none';
        return;
      }
      
      wrap.querySelector('.addonsWrap').style.display = '';

      adds.forEach(ad => {
        const row = document.createElement('div');
        row.className = 'addon-row border border-gray-200 rounded-lg';
        row.dataset.addonId = ad.id;

        const label = document.createElement('div');
        label.className = 'mb-2';
        label.innerHTML = `
          <div class="lbl">${esc(ad.label)}</div>
          <div class="text-xs text-gray-600">Pricing: ${esc(ad.pricingMode)}${ad.rate ? ` @ ${money(ad.rate)}` : ''}</div>
        `;
        row.appendChild(label);

        let control;
        const mode = (ad.selectionMode || 'boolean').toLowerCase();
        
        if (mode === 'integer') {
          control = document.createElement('label');
          control.className = 'block';
          const max = Number(ad.maxQty) || 2;
          const opts = Array.from({ length: max + 1 }, (_, i) => `<option value="${i}">${i}</option>`).join('');
          control.innerHTML = `<span class="lbl">Quantity</span><select class="inp addonQty">${opts}</select>`;
        } else if (mode === 'string') {
          control = document.createElement('label');
          control.className = 'block';
          control.innerHTML = `<span class="lbl">Details</span><input type="text" class="inp addonText" placeholder="Enter details" />`;
        } else {
          control = document.createElement('label');
          control.className = 'inline-flex items-center gap-2';
          control.innerHTML = `<input type="checkbox" class="addonBool" /><span>Include</span>`;
        }
        
        row.appendChild(control);

        // Hours estimation for per-minute services
        if (meta.priceUnit === 'perMinute' && ad.needsHoursForPerMinute && String(ad.label || '').toLowerCase() !== 'additional camera') {
          const hoursWrap = document.createElement('label');
          hoursWrap.className = 'block mt-3';
          hoursWrap.innerHTML = `<span class="lbl">Estimated shoot hours</span><input type="number" min="1" value="1" class="inp addonHours" />`;
          row.appendChild(hoursWrap);
        }

        list.appendChild(row);

        // Enhanced update function with better data collection
        const updateVals = () => {
          const qtySel = row.querySelector('.addonQty');
          const txt = row.querySelector('.addonText');
          const chk = row.querySelector('.addonBool');
          const hrs = row.querySelector('.addonHours');

          // Store addon label for webhook data
          svc.addonLabels[ad.id] = ad.label;

          if (qtySel) {
            const value = Number(qtySel.value || 0);
            svc.addons[ad.id] = value;
            row.classList.toggle('addon-selected', value > 0);
          } else if (txt) {
            const value = txt.value || '';
            svc.addons[ad.id] = value;
            row.classList.toggle('addon-selected', value.trim().length > 0);
          } else if (chk) {
            const value = chk.checked ? 1 : 0;
            svc.addons[ad.id] = value;
            row.classList.toggle('addon-selected', chk.checked);
          }

          if (hrs) {
            svc.addonHours[ad.id] = Math.max(1, Number(hrs.value) || 1);
          }

          updateQuote();
        };

        row.addEventListener('input', updateVals);
        row.addEventListener('change', updateVals);
      });
    }

    // Event handlers
    typeSel.addEventListener('change', refreshSubs);

    subSel.addEventListener('change', function() {
      const offeringId = this.value;
      const meta = (CONFIG.catalog.pricing || []).find(p => p.offeringId === offeringId);
      
      if (!meta) {
        resetServiceUI();
        updateSubmitState();
        sendHeight();
        return;
      }

      // Update service state
      svc.offeringId = offeringId;
      svc.serviceKey = meta.serviceKey;
      svc.subType = meta.subType;

      // Configure UI based on service type
      const unit = meta.priceUnit || 'flat';
      const isEvent = ['videography', 'photography'].includes(meta.serviceKey.toLowerCase());

      // Show/hide relevant fields
      const show = (sel, required = false) => {
        const el = wrap.querySelector(sel);
        if (el) {
          el.style.display = '';
          if (required) el.required = true;
        }
      };

      const hide = sel => {
        const el = wrap.querySelector(sel);
        if (el) {
          el.style.display = 'none';
          el.required = false;
        }
      };

      // Event details
      if (isEvent || meta.requiresEventDetails) {
        show('.eventRow');
        show('.locationRow');
        const dateEl = wrap.querySelector('.date');
        const timeEl = wrap.querySelector('.time');
        const locEl = wrap.querySelector('.location');
        if (dateEl) dateEl.required = true;
        if (timeEl) timeEl.required = true;
        if (locEl) locEl.required = true;
      }

      // Quantity controls
      if (unit === 'perHour') {
        show('.qtyRow');
        wrap.querySelector('.hours').required = true;
      } else if (unit === 'perHeadshot') {
        show('.headshotRow');
        wrap.querySelector('.headshots').required = true;
      } else if (unit === 'perMinute') {
        show('.filmLenWrap');
      }

      // Complexity
      if (['Video Editing', 'Dance Film Production'].includes(meta.subType)) {
        show('.complexityWrap');
        const compSel = wrap.querySelector('.complexity');
        const help = wrap.querySelector('.help');
        compSel.addEventListener('change', () => {
          svc.complexity = compSel.value;
          help.textContent = meta.complexityTexts?.[svc.complexity] || '';
          updateQuote();
        });
      }

      // Audio
      const audioEligible = ['Dance Reel Express', 'Event Videography', 'Dance Film Production', 'Rehearsal Videography', 'Audition Reel'];
      if (audioEligible.includes(meta.subType)) {
        show('.audioWrap');
        wrap.querySelectorAll(`input[name="audio-${svc.id}"]`).forEach(r => {
          r.required = true;
          r.addEventListener('change', () => {
            if (r.checked) {
              svc.audio = r.value;
              updateQuote();
            }
          });
        });
      }

      // Render add-ons
      renderAddons(meta);

      updateQuote();
      updateSubmitState();
      sendHeight();
    });

    // Input handlers
    wrap.addEventListener('input', (e) => {
      const target = e.target;
      if (target.classList.contains('date')) svc.date = target.value;
      else if (target.classList.contains('time')) svc.time = target.value;
      else if (target.classList.contains('location')) svc.location = target.value;
      else if (target.classList.contains('hours')) svc.hours = Math.max(1, Number(target.value) || 1);
      else if (target.classList.contains('headshots')) svc.units = Math.max(1, Number(target.value) || 1);
      else if (target.classList.contains('filmSlider')) {
        svc.units = Number(target.value) || 1;
        wrap.querySelector('.filmLenDisplay').textContent = svc.units;
        updateSliderFill(target);
      }
      
      updateQuote();
    });

    // Remove service handler
    const removeBtn = wrap.querySelector('.removeService');
    if (removeBtn) {
      removeBtn.addEventListener('click', () => {
        state.services = state.services.filter(x => x.id !== svc.id);
        wrap.remove();
        updateQuote();
        updateSubmitState();
        sendHeight();
      });
    }

    return wrap;
  }

  // Add service functionality
  function addService() {
    const id = Date.now() + Math.random();
    const svc = createServiceState(id);
    state.services.push(svc);
    
    const card = buildServiceCard(svc);
    document.getElementById('servicesContainer').appendChild(card);
    
    updateSubmitState();
    sendHeight();
  }

  // Quote calculation
  function updateQuote() {
    if (!CONFIG.catalog) return;
    
    let total = 0;
    let breakdown = '';
    const discountPercent = bestDiscountPercent();

    state.services.forEach((svc, idx) => {
      const meta = (CONFIG.catalog.pricing || []).find(p => p.offeringId === svc.offeringId);
      if (!meta) return;

      let serviceTotal = 0;
      const unit = meta.priceUnit || 'flat';
      const rate = Number(meta.rate) || 0;

      if (unit === 'flat') {
        serviceTotal = rate;
      } else if (unit === 'perHour') {
        serviceTotal = rate * (Number(svc.hours) || 1);
      } else if (unit === 'perMinute') {
        serviceTotal = rate * (Number(svc.units) || 1);
      } else if (unit === 'perHeadshot') {
        serviceTotal = rate * (Number(svc.units) || 1);
      }

      // Add addon costs
      let addonCost = 0;
      Object.keys(svc.addons).forEach(addonId => {
        const addonValue = svc.addons[addonId];
        const addon = (CONFIG.catalog.addons || []).find(a => a.id === addonId);
        if (!addon || !addonValue) return;

        const addonRate = Number(addon.rate) || 0;
        const addonMode = (addon.pricingMode || '').toLowerCase();

        if (addonMode === 'flat') {
          if (typeof addonValue === 'number' && addonValue > 0) addonCost += addonRate;
          else if (typeof addonValue === 'string' && addonValue.trim()) addonCost += addonRate;
        } else if (addonMode === 'per-quantity') {
          addonCost += addonRate * (Number(addonValue) || 0);
        }
        // Add more pricing modes as needed
      });

      serviceTotal += addonCost;
      total += serviceTotal;

      if (idx === 0) breakdown += `Service ${idx + 1}: ${meta.subType}\n`;
      else breakdown += `\nService ${idx + 1}: ${meta.subType}\n`;
      
      breakdown += `  Base: ${money(serviceTotal - addonCost)}\n`;
      if (addonCost > 0) breakdown += `  Add-ons: ${money(addonCost)}\n`;
      breakdown += `  Subtotal: ${money(serviceTotal)}`;
    });

    if (discountPercent > 0) {
      const discountAmount = total * (discountPercent / 100);
      breakdown += `\n\nSubtotal: ${money(total)}`;
      breakdown += `\nDiscount (${discountPercent}%): -${money(discountAmount)}`;
      total -= discountAmount;
    }

    document.getElementById('quoteTotal').textContent = money(total);
    document.getElementById('quoteBreakdown').textContent = breakdown;
    
    sendHeightDebounced();
  }

  function bestDiscountPercent() {
    const discount = document.querySelector('input[name="selfDiscount"]:checked')?.value;
    switch (discount) {
      case 'student': case 'nonprofit': return 10;
      case 'artist': return 20;
      default: return 0;
    }
  }

  // Form validation
  function updateSubmitState() {
    const btn = document.getElementById('submitBtn');
    if (btn && btn.dataset.loading === '1') return;

    const errors = [];
    
    // Basic fields
    const firstName = document.getElementById('firstNameInput').value.trim();
    const lastName = document.getElementById('lastNameInput').value.trim();
    const email = document.getElementById('emailInput').value.trim();
    
    if (!firstName) errors.push('First name required');
    if (!lastName) errors.push('Last name required');
    if (!email) errors.push('Email required');
    if (email && !email.includes('@')) errors.push('Valid email required');
    
    // Required checkboxes
    const tosCheck = document.getElementById('tosCheck')?.checked;
    const understandCheck = document.getElementById('understandCheck')?.checked;
    if (!tosCheck) errors.push('Terms of service agreement required');
    if (!understandCheck) errors.push('Booking acknowledgment required');
    
    // Services
    if (!state.services.length) errors.push('At least one service required');
    
    state.services.forEach((svc, idx) => {
      if (!svc.offeringId) errors.push(`Service ${idx + 1} type required`);
      
      const meta = (CONFIG.catalog.pricing || []).find(p => p.offeringId === svc.offeringId);
      if (meta) {
        const isEvent = ['videography', 'photography'].includes(meta.serviceKey.toLowerCase());
        if (isEvent || meta.requiresEventDetails) {
          if (!svc.date) errors.push(`Service ${idx + 1} date required`);
          if (!svc.time) errors.push(`Service ${idx + 1} time required`);
          if (!svc.location) errors.push(`Service ${idx + 1} location required`);
        }
        
        // Audio requirement for eligible services
        const audioEligible = ['Dance Reel Express', 'Event Videography', 'Dance Film Production', 'Rehearsal Videography', 'Audition Reel'];
        if (audioEligible.includes(meta.subType) && svc.audio === null) {
          errors.push(`Service ${idx + 1} audio preference required`);
        }
      }
    });

    const isValid = errors.length === 0;
    btn.disabled = !isValid;
    btn.className = `btn ${isValid ? 'btn-primary' : 'btn-disabled'}`;
    
    return isValid;
  }

  // Form submission with enhanced addon data
  async function submitRequest() {
    const btn = document.getElementById('submitBtn');
    btn.dataset.loading = '1';
    btn.innerHTML = '<span class="spinner">⏳</span>Submitting...';
    btn.disabled = true;

    try {
      const primary = state.services[0] || {};
      const meta = (CONFIG.catalog.pricing || []).find(p => p.offeringId === primary.offeringId) || {};
      const unit = meta.priceUnit || 'flat';

      // Enhanced payload with better addon data structure
      const payload = {
        firstName: document.getElementById('firstNameInput').value,
        lastName: document.getElementById('lastNameInput').value,
        email: document.getElementById('emailInput').value.trim().toLowerCase(),
        organizationName: document.getElementById('orgInput')?.value || '',
        discountCategory: (document.querySelector('input[name="selfDiscount"]:checked')?.value || 'none'),
        discountAppliedPercent: bestDiscountPercent(),
        mailingOptIn: (document.querySelector('input[name="mailing"]:checked')?.value === 'yes'),
        additionalInfo: document.getElementById('additionalInfo')?.value || '',
        requestedProviders: document.getElementById('requestedProviders')?.value || '',
        
        // Enhanced services data with addon details
        services: state.services.map(svc => ({
          ...svc,
          // Ensure addon data is properly structured
          addons: svc.addons || {},
          addonHours: svc.addonHours || {},
          addonLabels: svc.addonLabels || {}, // Include labels for webhook processing
          
          // Add metadata for better webhook handling
          _meta: {
            serviceCategory: svc.serviceKey,
            serviceType: svc.subType,
            pricingUnit: meta.priceUnit || 'flat'
          }
        })),
        
        quoteTotal: document.getElementById('quoteTotal').textContent,
        quoteBreakdown: document.getElementById('quoteBreakdown').innerText,
        primaryDateTime: combineDateTime(primary.date, primary.time),
        primaryEndTime: (unit === 'perHour' && primary.time && primary.hours) ? addHoursToTime(primary.time, primary.hours) : '',
        primaryVenue: primary.location || '',
        primaryServiceType: meta.subType || '',
        needsAudioRecording: (isVideography(meta) && !isVideoEditing(meta)) ? (primary.audio === 'yes' ? 'Yes, please record audio' : (primary.audio === 'no' ? 'No audio required' : '')) : '',
        tosAccepted: !!document.getElementById('tosCheck')?.checked,
        bookingAcknowledge: !!document.getElementById('understandCheck')?.checked
      };

      const url = `${CONFIG.api.baseUrl}${CONFIG.api.webhookPath}`;
      const response = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (response.ok) {
        // Show success message
        document.getElementById('intakeForm').style.display = 'none';
        document.getElementById('successMessage').style.display = '';
        document.getElementById('submissionTime').textContent = new Date().toLocaleString();
        sendHeightImmediate();
      } else {
        throw new Error(`Server error: ${response.status}`);
      }

    } catch (error) {
      console.error('Submission error:', error);
      alert('There was an error submitting your request. Please try again or contact us directly.');
      
      btn.dataset.loading = '0';
      btn.innerHTML = 'Submit Request';
      btn.disabled = false;
    }
  }

  // Helper functions
  function isVideography(meta) {
    return (meta.serviceKey || '').toLowerCase() === 'videography';
  }

  function isVideoEditing(meta) {
    return (meta.subType || '').toLowerCase().includes('editing');
  }

  // -------- INITIALIZATION --------
  async function init() {
    try {
      // Load catalog
      await loadCatalog();
      
      // Add initial service
      addService();
      
      // Event listeners
      document.getElementById('addServiceBtn').addEventListener('click', addService);
      
      document.getElementById('intakeForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!e.target.checkValidity()) {
          updateSubmitState();
          return;
        }
        await submitRequest();
      });
      
      // Discount change handler
      document.querySelectorAll('input[name="selfDiscount"]').forEach(radio => {
        radio.addEventListener('change', updateQuote);
      });
      
      // Form validation
      document.getElementById('intakeForm').addEventListener('input', updateSubmitState);
      document.getElementById('intakeForm').addEventListener('change', updateSubmitState);
      
      // Initial state
      updateSubmitState();
      sendHeightImmediate();
      
    } catch (error) {
      console.error('Initialization error:', error);
      renderFatal('Failed to load service catalog. Please refresh the page or contact support.');
    }
  }

  // Start the application
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }

  // Height monitoring
  new ResizeObserver(sendHeightDebounced).observe(document.body);

</script>

</body>
</html>
